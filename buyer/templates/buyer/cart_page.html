{% extends "index.html" %}
{% load b64filters %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .cart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .cart-title {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .back-btn:hover {
            background: #0056b3;
        }

        .back-btn::before {
            content: '‚Üê';
            margin-right: 8px;
            font-size: 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 40px;
        }

        .cart-items {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            gap: 20px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .item-image.tshirt-1 { background-color: #4a90a4; }
        .item-image.tshirt-2 { background-color: #2c5aa0; }
        .item-image.tshirt-3 { background-color: #8b7355; }

        .item-details {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .item-specs {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .item-seller {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .item-actions {
            display: flex;
            gap: 15px;
        }

        .remove-btn, .save-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
        }

        .remove-btn {
            color: #dc3545;
        }

        .save-btn {
            color: #007bff;
        }

        .item-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .item-price {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .order-summary {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .coupon-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .coupon-header {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .coupon-input-group {
            display: flex;
            gap: 8px;
        }

        .coupon-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .apply-btn {
            padding: 10px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .apply-btn:hover {
            background: #0056b3;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .summary-row.discount .summary-value {
            color: #dc3545;
        }

        .summary-row.tax .summary-value {
            color: #28a745;
        }

        .summary-row.total {
            font-size: 18px;
            font-weight: 600;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            margin-top: 12px;
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: background-color 0.3s;
        }

        .checkout-btn:hover {
            background: #1e7e34;
        }

        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .payment-icon {
            width: 32px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .features-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .feature-content h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feature-content p {
            font-size: 14px;
            color: #666;
        }

        .saved-items-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .saved-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .saved-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }

        .saved-item-image {
            width: 100%;
            height: 160px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .saved-item-image.tablet { background-color: #ff6b6b; }
        .saved-item-image.phone { background-color: #4ecdc4; }
        .saved-item-image.watch { background-color: #45b7d1; }
        .saved-item-image.laptop { background-color: #f9ca24; }

        .saved-item-price {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .saved-item-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .move-to-cart-btn {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .move-to-cart-btn:hover {
            background: #0056b3;
        }

        .promo-banner {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .promo-content h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .promo-content p {
            font-size: 14px;
            opacity: 0.9;
        }

        .shop-now-btn {
            padding: 12px 24px;
            background: #ffa500;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .remove-all-btn {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
        }

        .remove-all-btn:hover {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .cart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .cart-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 20px;
            }

            .item-details {
                width: 100%;
            }

            .item-controls {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            .features-section {
                grid-template-columns: 1fr;
            }

            .saved-items-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .promo-banner {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
        }

        @media (max-width: 480px) {
            .cart-item {
                padding: 15px;
            }

            .item-image {
                width: 60px;
                height: 60px;
            }

            .saved-items-grid {
                grid-template-columns: 1fr;
            }

            .order-summary {
                padding: 20px;
            }
        }
    </style>
</head>
<body> 
    <div class="container">
        <form id="csrf-form" style="display:none;">{% csrf_token %}</form>
        <!-- Cart Header -->
        <div class="cart-header">
            <h1 class="cart-title">My cart ({{ cart_items|length }})</h1>
            <a href="#" class="remove-all-btn">Remove all</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Cart Items -->
            <div class="cart-items">
                {% for item in cart_items %}
                    <div class="cart-item">
                        <div class="item-image">
                            {% if item.product.images.first %}
                                <img src="data:image/jpeg;base64,{{ item.product.images.first.image|b64encode }}" style="width:60px;height:60px;object-fit:cover;">
                            {% else %}
                                üõí
                            {% endif %}
                        </div>
                        <div class="item-details">
                            <div class="item-title">{{ item.product.name }}</div>
                            <div class="item-specs">
                                {% for attr in item.product.attribute_values.all %}
                                    {{ attr.attribute.name }}: {{ attr.value }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            <div class="item-seller">Seller: {{ item.product.seller.shop_name }}</div>
                            <div class="item-actions">
                                <button class="remove-btn">Remove</button>
                                <button class="save-btn">Save for later</button>
                            </div>
                        </div>
                        <div class="item-controls">
                            <div class="item-price" data-unit-price="{{ item.product.price }}">
                                ${{ item.total_price|floatformat:2 }}
                            </div>
                            <div class="quantity-control">
                                <label for="quantity-{{ item.product.id }}">Qty:</label>
                                <input 
                                    type="number" 
                                    class="quantity-input" 
                                    id="quantity-{{ item.product.id }}"
                                    name="quantity"
                                    value="{{ item.quantity }}"
                                    min="1"
                                    data-product-id="{{ item.product.id }}"
                                    data-unit-price="{{ item.product.price }}"
                                >
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <div class="coupon-section">
                    <div class="coupon-header">Have a coupon?</div>
                    <div class="coupon-input-group">
                        <input type="text" class="coupon-input" placeholder="Add coupon">
                        <button class="apply-btn">Apply</button>
                    </div>
                </div>

                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span class="summary-value">${{ subtotal|floatformat:2 }}</span>
                </div>
                <div class="summary-row discount">
                    <span>Discount:</span>
                    <span class="summary-value">- $60.00</span>
                </div>
                <div class="summary-row tax">
                    <span>Tax:</span>
                    <span class="summary-value">+ $14.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span class="summary-value">${{ total|floatformat:2 }}</span>
                </div>

                <button class="checkout-btn">Checkout</button>

                <div class="payment-methods">
                    <div class="payment-icon" style="background-color: #1a73e8; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #ff5f00; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #003087; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #635bff; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #000; border-radius: 4px;"></div>
                </div>
            </div>
        </div>

        <!-- Back to Shop Button -->
        <a href="#" class="back-btn">Back to shop</a>

        <!-- Features Section -->
        <div class="features-section">
            <div class="feature-item">
                <div class="feature-icon">üîí</div>
                <div class="feature-content">
                    <h3>Secure payment</h3>
                    <p>Have you ever finally just</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">üí¨</div>
                <div class="feature-content">
                    <h3>Customer support</h3>
                    <p>Have you ever finally just</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">üöö</div>
                <div class="feature-content">
                    <h3>Free delivery</h3>
                    <p>Have you ever finally just</p>
                </div>
            </div>
        </div>

        <!-- Saved Items Section -->
        <div class="saved-items-section">
            <h2 class="section-title">Saved for later</h2>
            <div class="saved-items-grid">
                <div class="saved-item">
                    <div class="saved-item-image tablet">üì±</div>
                    <div class="saved-item-price">$99.50</div>
                    <div class="saved-item-title">GoPro HERO6 4K Action Camera - Black</div>
                    <button class="move-to-cart-btn">
                        üõí Move to cart
                    </button>
                </div>
                <div class="saved-item">
                    <div class="saved-item-image phone">üì±</div>
                    <div class="saved-item-price">$99.50</div>
                    <div class="saved-item-title">GoPro HERO6 4K Action Camera - Black</div>
                    <button class="move-to-cart-btn">
                        üõí Move to cart
                    </button>
                </div>
                <div class="saved-item">
                    <div class="saved-item-image watch">‚åö</div>
                    <div class="saved-item-price">$99.50</div>
                    <div class="saved-item-title">GoPro HERO6 4K Action Camera - Black</div>
                    <button class="move-to-cart-btn">
                        üõí Move to cart
                    </button>
                </div>
                <div class="saved-item">
                    <div class="saved-item-image laptop">üíª</div>
                    <div class="saved-item-price">$99.50</div>
                    <div class="saved-item-title">GoPro HERO6 4K Action Camera - Black</div>
                    <button class="move-to-cart-btn">
                        üõí Move to cart
                    </button>
                </div>
            </div>
        </div>

        <!-- Promotional Banner -->
        <div class="promo-banner">
            <div class="promo-content">
                <h2>Super discount on more than 100 USD</h2>
                <p>Have you ever finally just write dummy info</p>
            </div>
            <button class="shop-now-btn">Shop now</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to safely parse numbers and handle invalid values
            function safeParseFloat(value, defaultValue = 0) {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : parsed;
            }

            // Function to update cart totals
            function updateCartTotals() {
                let subtotal = 0;
                document.querySelectorAll('.cart-item').forEach(cartItem => {
                    const input = cartItem.querySelector('.quantity-input');
                    const quantity = parseInt(input.value, 10) || 1;
                    const unitPrice = safeParseFloat(input.getAttribute('data-unit-price'));
                    const itemPrice = quantity * unitPrice;
                    
                    // Update individual item price
                    cartItem.querySelector('.item-price').textContent = `$${itemPrice.toFixed(2)}`;
                    subtotal += itemPrice;
                });

                // Calculate totals
                const discount = 60.00; // You can make this dynamic if needed
                const tax = subtotal * 0.10; // 10% tax
                const total = subtotal - discount + tax;

                // Update summary values
                document.querySelector('.summary-row:nth-child(1) .summary-value').textContent = `$${subtotal.toFixed(2)}`;
                document.querySelector('.summary-row.discount .summary-value').textContent = `- $${discount.toFixed(2)}`;
                document.querySelector('.summary-row.tax .summary-value').textContent = `+ $${tax.toFixed(2)}`;
                document.querySelector('.summary-row.total .summary-value').textContent = `$${total.toFixed(2)}`;
            }

            // Function to show notification
            function showNotification(message, isError = false) {
                const notification = document.createElement('div');
                notification.className = `notification ${isError ? 'error' : 'success'}`;
                notification.textContent = message;
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '4px';
                notification.style.backgroundColor = isError ? '#ff4444' : '#00C851';
                notification.style.color = 'white';
                notification.style.zIndex = '1000';
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            // Handle quantity changes
            document.querySelectorAll('.quantity-input').forEach(input => {
                let timeout;
                
                input.addEventListener('change', function() {
                    const quantity = parseInt(this.value, 10) || 1;
                    if (quantity < 1) {
                        this.value = 1;
                        return;
                    }

                    clearTimeout(timeout);
                    
                    const productId = this.getAttribute('data-product-id');
                    const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                    // Update UI immediately for better UX
                    updateCartTotals();

                    // Send update to server
                    fetch('/cart/update/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `product_id=${productId}&quantity=${quantity}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Cart updated successfully');
                            // Update cart count in header if needed
                            const cartCountElement = document.querySelector('.cart-count');
                            if (cartCountElement) {
                                cartCountElement.textContent = data.cart_count || '';
                            }
                        } else {
                            showNotification(data.error || 'Failed to update cart', true);
                            // Revert to previous value if update failed
                            this.value = this.defaultValue;
                            updateCartTotals();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating cart:', error);
                        showNotification('Error updating cart', true);
                        // Revert to previous value on error
                        this.value = this.defaultValue;
                        updateCartTotals();
                    });

                    // Store current value as default for potential rollback
                    this.defaultValue = this.value;
                });
            });

            // Initialize totals on page load
            updateCartTotals();
        });

        // Remove item handler
        document.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const cartItem = this.closest('.cart-item');
                const productId = cartItem.querySelector('.quantity-input').getAttribute('data-product-id');
                const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;
                fetch('/cart/remove/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `product_id=${productId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cartItem.remove();
                        updateCartTotals();
                        updateCartCount();
                    } else {
                        alert('Could not remove item from cart.');
                    }
                })
                .catch(() => alert('Error removing item from cart.'));
            });
        });

        // Save for later handler
        document.querySelectorAll('.save-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                alert('Item saved for later!');
            });
        });

        // Move to cart handler
        document.querySelectorAll('.move-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                alert('Item moved to cart!');
            });
        });

        // Coupon application
        document.querySelector('.apply-btn').addEventListener('click', function() {
            const couponInput = document.querySelector('.coupon-input');
            const couponCode = couponInput.value.trim();
            
            if (couponCode) {
                alert(`Coupon "${couponCode}" applied!`);
                couponInput.value = '';
                // Update discount amount here
                document.querySelector('.summary-row.discount .summary-value').textContent = '- $80.00';
                updateCartTotals();
            }
        });

        // Update cart totals
        function updateCartTotals() {
            const subtotal = 1403.97;
            const discount = 60.00;
            const tax = 14.00;
            const total = subtotal - discount + tax;
            
            document.querySelector('.summary-row.total .summary-value').textContent = `$${total.toFixed(2)}`;
        }

        function updateCartSummary(cart) {
            document.querySelector('.summary-row.total .summary-value').textContent = `$${cart.total.toFixed(2)}`;
            document.querySelector('.summary-row.tax .summary-value').textContent = `+ $${cart.tax.toFixed(2)}`;
            document.querySelector('.summary-row.discount .summary-value').textContent = `- $${cart.discount.toFixed(2)}`;
            document.querySelector('.summary-row:nth-child(1) .summary-value').textContent = `$${cart.subtotal.toFixed(2)}`;
        }

        // Update cart count
        function updateCartCount() {
            const cartItems = document.querySelectorAll('.cart-item').length;
            document.querySelector('.cart-title').textContent = `My cart (${cartItems})`;
        }

        // Checkout handler
        document.querySelector('.checkout-btn').addEventListener('click', function() {
            alert('Proceeding to checkout...');
        });

        // Responsive behavior
        function handleResize() {
            const orderSummary = document.querySelector('.order-summary');
            if (window.innerWidth <= 768) {
                orderSummary.style.position = 'static';
            } else {
                orderSummary.style.position = 'sticky';
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize(); // Initial call
        updateCartTotals(); // Initialize totals on page load
    </script>
{% endblock %}
{% block extra_js %}
<script>
// Place any cart-specific JS here if needed
</script>
{% endblock %}
</body>
</html>