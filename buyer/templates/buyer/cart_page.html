{% extends "index.html" %}
{% load b64filters %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .cart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .cart-title {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .back-btn:hover {
            background: #0056b3;
        }

        .back-btn::before {
            content: '‚Üê';
            margin-right: 8px;
            font-size: 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 40px;
        }

        .cart-items {
            background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            gap: 20px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .item-image {
            width: 80px;
            height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .item-image.tshirt-1 { background-color: #4a90a4; }
        .item-image.tshirt-2 { background-color: #2c5aa0; }
        .item-image.tshirt-3 { background-color: #8b7355; }

        .item-details {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .item-specs {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .item-seller {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .item-actions {
            display: flex;
            gap: 15px;
        }

        .remove-btn, .save-btn {
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
        }

        .remove-btn {
            color: #dc3545;
        }

        .save-btn {
            color: #007bff;
        }

        .item-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .item-price {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        .order-summary {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .coupon-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .coupon-header {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .coupon-input-group {
            display: flex;
            gap: 8px;
        }

        .coupon-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .apply-btn {
            padding: 10px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .apply-btn:hover {
            background: #0056b3;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .summary-row.discount .summary-value {
            color: #dc3545;
        }

        .summary-row.tax .summary-value {
            color: #28a745;
        }

        .summary-row.total {
            font-size: 18px;
            font-weight: 600;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            margin-top: 12px;
        }

        .checkout-btn {
            width: 100%;
            padding: 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: background-color 0.3s;
        }

        .checkout-btn:hover {
            background: #1e7e34;
        }

        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .payment-icon {
            width: 32px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .features-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: #f8f9fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .feature-content h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feature-content p {
            font-size: 14px;
            color: #666;
        }

        .saved-items-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .saved-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .saved-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }

        .saved-item-image {
            width: 100%;
            height: 160px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .saved-item-image.tablet { background-color: #ff6b6b; }
        .saved-item-image.phone { background-color: #4ecdc4; }
        .saved-item-image.watch { background-color: #45b7d1; }
        .saved-item-image.laptop { background-color: #f9ca24; }

        .saved-item-price {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .saved-item-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .move-to-cart-btn {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .move-to-cart-btn:hover {
            background: #0056b3;
        }

        .promo-banner {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .promo-content h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .promo-content p {
            font-size: 14px;
            opacity: 0.9;
        }

        .shop-now-btn {
            padding: 12px 24px;
            background: #ffa500;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .remove-all-btn {
            color: #007bff;
            background-color: white;
            border: 1px solid #3578dc;
            text-decoration: none;
            font-size: 14px;
        }

        .remove-all-btn:hover {
            text-decoration: underline;
        }

        .remove-all-btn {
            background: none;
            border: none;
            color: #3578dc;
            font-size: 14px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .remove-all-btn:hover {
            background: #4635e320;
        }

        .empty-cart {
            text-align: center;
            padding: 48px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 20px 0;
        }

        .empty-cart i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 16px;
        }

        .empty-cart p {
            color: #666;
            margin-bottom: 20px;
        }

        .empty-cart .shop-now-link {
            display: inline-block;
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .empty-cart .shop-now-link:hover {
            background: #3367d6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .cart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .cart-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 20px;
            }

            .item-details {
                width: 100%;
            }

            .item-controls {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            .features-section {
                grid-template-columns: 1fr;
            }

            .saved-items-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .promo-banner {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
        }

        @media (max-width: 480px) {
            .cart-item {
                padding: 15px;
            }

            .item-image {
                width: 60px;
                height: 60px;
            }

            .saved-items-grid {
                grid-template-columns: 1fr;
            }

            .order-summary {
                padding: 20px;
            }
        }

        .cart-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .back-btn {
            margin-left: 20px;
            color: white;
            text-decoration: none;
            font-size: 14px;
            background-color: #3578dc;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .back-btn:hover {
            text-decoration: none;
            background-color: #2461c0;
        }

        .remove-all-btn {
            margin-right: 20px;
            padding: 8px 16px;
            background-color: white;
            border: 1px solid #3578dc;
            color: #3578dc;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .remove-all-btn:hover {
            background: #4635e320;
        }

        .saved-items {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-top: 20px;
            max-width: 1200px;
        }

        .saved-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }

        .saved-item:last-child {
            border-bottom: none;
        }

        .saved-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .saved-item-details {
            flex: 1;
        }

        .saved-item-details h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: #333;
        }

        .saved-item-details p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }

        .saved-item-actions {
            display: flex;
            gap: 10px;
        }

        .saved-item-actions button {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .move-to-cart-btn {
            background-color: #3578dc;
            color: white;
            border: none;
        }

        .move-to-cart-btn:hover {
            background-color: #2461c0;
        }

        .remove-from-wishlist-btn {
            background-color: white;
            color: #3578dc;
            border: 1px solid #3578dc;
        }

        .remove-from-wishlist-btn:hover {
            background-color: #4635e320;
        }

        .saved-items-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .saved-items-header h2 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .empty-wishlist {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body> 
    <div class="container">
        <form id="csrf-form" style="display:none;">{% csrf_token %}</form>
        <!-- Update the cart header -->
        <div class="cart-header">
            <h1 class="cart-title">My cart ({{ cart_items|length }})</h1>
            
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Cart Items -->
            <div class="cart-items">
                {% if cart_items %}
                    <div class="cart-items-container">
                {% for item in cart_items %}
                            <div class="cart-item" data-product-id="{{ item.product.id }}">
                        <div class="item-image">
                            <a href="{% url 'sellers:product_page' item.product.id %}">
                                {% if item.product.images.first %}
                                    <img src="data:image/jpeg;base64,{{ item.product.images.first.image|b64encode }}" style="width:60px;height:60px;object-fit:cover;">
                                {% else %}
                                    üõí
                                {% endif %}
                            </a>
                        </div>
                        <div class="item-details">
                            <div class="item-title">
                                <a href="{% url 'sellers:product_page' item.product.id %}" style="color:inherit;text-decoration:none;">
                                    {{ item.product.name }}
                                </a>
                            </div>
                            <div class="item-specs">
                                {% for attr in item.product.attribute_values.all %}
                                    {{ attr.attribute.name }}: {{ attr.value }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            <div class="item-seller">Seller: {{ item.product.seller.shop_name }}</div>
                            <div class="item-actions">
                                <button class="remove-btn">Remove</button>
                                <button class="save-btn">Save for later</button>
                            </div>
                        </div>
                        <div class="item-controls">
                                    <div class="item-price" data-unit-price="{{ item.product.final_price }}">
                                        ${{ item.product.final_price|floatformat:2 }}
                                    </div>
                            <div class="quantity-control">
                                        <label for="quantity-{{ item.product.id }}">Qty:</label>
                                        <input 
                                            type="number" 
                                            class="quantity-input" 
                                            id="quantity-{{ item.product.id }}"
                                            name="quantity"
                                            value="{{ item.quantity }}"
                                            min="1"
                                            data-product-id="{{ item.product.id }}"
                                            data-unit-price="{{ item.product.final_price }}"
                                            style="width: 70px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;"
                                        >
                            </div>
                        </div>
                    </div>
                {% endfor %}
                    </div>
                    <div class="cart-footer">
                        <a href="{% url 'seller:index' %}" class="back-btn">Back to shop</a>
                        <button class="remove-all-btn">Remove all</button>
                    </div>
                {% else %}
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Your cart is empty</p>
                        <a href="{% url 'seller:index' %}" class="shop-now-link">
                            Continue Shopping
                        </a>
                    </div>
                {% endif %}
            </div>

            <!-- Order Summary -->
            {% if cart_items %}
            <div class="order-summary">
                <div class="coupon-section">
                    <div class="coupon-header">Have a coupon?</div>
                    <div class="coupon-input-group">
                        <input type="text" class="coupon-input" placeholder="Add coupon">
                        <button class="apply-btn">Apply</button>
                    </div>
                </div>

                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span class="summary-value">${{ subtotal|floatformat:2 }}</span>
                </div>
                <div class="summary-row discount">
                    <span>Discount:</span>
                    <span class="summary-value">- $60.00</span>
                </div>
                <div class="summary-row tax">
                    <span>Tax:</span>
                    <span class="summary-value">+ $14.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span class="summary-value">${{ total|floatformat:2 }}</span>
                </div>

                <a href="{% url 'buyer:checkout_page' %}"><button class="checkout-btn">Checkout</button></a>

                <div class="payment-methods">
                    <div class="payment-icon" style="background-color: #1a73e8; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #ff5f00; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #003087; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #635bff; border-radius: 4px;"></div>
                    <div class="payment-icon" style="background-color: #000; border-radius: 4px;"></div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Back to Shop Button - Only show if cart has items -->
        

        <!-- Features Section -->
        <div class="features-section">
            <div class="feature-item">
                <div class="feature-icon">üîí</div>
                <div class="feature-content">
                    <h3>Secure payment</h3>
                    <p>Have you ever finally just</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">üí¨</div>
                <div class="feature-content">
                    <h3>Customer support</h3>
                    <p>Have you ever finally just</p>
                </div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">üöö</div>
                <div class="feature-content">
                    <h3>Free delivery</h3>
                    <p>Have you ever finally just</p>
                </div>
            </div>
        </div>

        <!-- Update the saved items section HTML structure -->
<div class="saved-items">
    <h2>Saved for later</h2>
            <div class="saved-items-grid">
        {% if wishlist_items %}
            {% for item in wishlist_items %}
                <div class="saved-item">
                    <div class="saved-item-image">
                        <a href="{% url 'sellers:product_page' item.product.id %}">
                            <img src="data:image/jpeg;base64,{{ item.product.images.first.image|b64encode }}" alt="{{ item.product.name }}" style="width:120px;height:120px;object-fit:cover;">
                        </a>
                    </div>
                    <div class="saved-item-details">
                        <h3>
                            <a href="{% url 'sellers:product_page' item.product.id %}" style="color:inherit;text-decoration:none;">
                                {{ item.product.name }}
                            </a>
                        </h3>
                        <p class="price">${{ item.product.final_price }}</p>
                    </div>
                    <!-- Update the saved item actions div -->
                    <div class="saved-item-actions">
                        <button class="move-to-cart-btn" data-product-id="{{ item.product.id }}">
                            <i class="fas fa-shopping-cart"></i> Move to cart
                    </button>
                        <button class="remove-from-wishlist-btn" data-product-id="{{ item.product.id }}">
                            <i class="fas fa-times"></i> Remove
                    </button>
                </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-wishlist">
                <p>No items saved for later</p>
            </div>
        {% endif %}
            </div>
        </div>

<!-- Update the CSS -->
<style>
    .saved-items {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-top: 20px;
    }

    .saved-items h2 {
        margin: 0 0 20px 0;
        font-size: 18px;
        color: #333;
    }

    .saved-items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
    }

    .saved-item {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .saved-item-image {
        width: 100%;
        aspect-ratio: 1;
        overflow: hidden;
        border-radius: 4px;
        background: white;
    }

    .saved-item-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .saved-item-details {
        text-align: left;
    }

    .saved-item-details h3 {
        margin: 0;
        font-size: 14px;
        color: #333;
        line-height: 1.4;
    }

    .saved-item-details .price {
        margin: 5px 0;
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }

    .saved-item-actions {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .move-to-cart-btn, .remove-from-wishlist-btn {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .move-to-cart-btn {
        background-color: #0d6efd;
        color: white;
        border: none;
    }

    .move-to-cart-btn:hover {
        background-color: #0b5ed7;
    }

    .remove-from-wishlist-btn {
        background-color: white;
        color: #dc3545;
        border: 1px solid #dc3545;
    }

    .remove-from-wishlist-btn:hover {
        background-color: #dc3545;
        color: white;
    }

    .empty-wishlist {
        grid-column: 1 / -1;
        text-align: center;
        padding: 30px;
        color: #666;
    }

    @media (max-width: 768px) {
        .saved-items-grid {
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }
    }
</style>

        <!-- Promotional Banner -->
        <div class="promo-banner">
            <div class="promo-content">
                <h2>Super discount on more than 100 USD</h2>
                <p>Have you ever finally just write dummy info</p>
            </div>
            <button class="shop-now-btn">Shop now</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to safely parse numbers and handle invalid values
            function safeParseFloat(value, defaultValue = 0) {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : Number(parsed.toFixed(2));
            }

            // Function to format currency
            function formatCurrency(amount) {
                const roundedAmount = Number(Number(amount).toFixed(2));
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(roundedAmount);
            }

            // Function to update individual item price
            function updateItemPrice(cartItem, quantity, unitPrice) {
                const itemPrice = Number((quantity * unitPrice).toFixed(2));
                const priceElement = cartItem.querySelector('.item-price');
                if (priceElement) {
                    priceElement.textContent = formatCurrency(itemPrice);
                }
                return itemPrice;
            }

            // Function to update cart UI with server data
            function updateCartUI(data) {
                console.log('Updating cart UI with data:', data);

                // Update each item's price
                document.querySelectorAll('.cart-item').forEach(cartItem => {
                    const input = cartItem.querySelector('.quantity-input');
                    const quantity = parseInt(input.value, 10) || 1;
                    const unitPrice = safeParseFloat(input.getAttribute('data-unit-price'));
                    updateItemPrice(cartItem, quantity, unitPrice);
                });

                // Update summary values
                const summaryRows = document.querySelectorAll('.summary-row');
                if (summaryRows.length >= 4) {  // Make sure we have all summary rows
                    // Update subtotal
                    summaryRows[0].querySelector('.summary-value').textContent = formatCurrency(data.subtotal);
                    
                    // Update discount
                    const discountRow = document.querySelector('.summary-row.discount .summary-value');
                    if (discountRow) {
                        discountRow.textContent = `- ${formatCurrency(data.discount)}`;
                    }
                    
                    // Update tax
                    const taxRow = document.querySelector('.summary-row.tax .summary-value');
                    if (taxRow) {
                        taxRow.textContent = `+ ${formatCurrency(data.tax)}`;
                    }
                    
                    // Update total
                    const totalRow = document.querySelector('.summary-row.total .summary-value');
                    if (totalRow) {
                        totalRow.textContent = formatCurrency(data.total);
                    }
                }

                // Update cart count
                const cartCountElement = document.querySelector('.cart-count');
                if (cartCountElement) {
                    cartCountElement.textContent = data.cart_count || '';
                }

                // Update cart title
                const cartTitleElement = document.querySelector('.cart-title');
                if (cartTitleElement) {
                    cartTitleElement.textContent = `My cart (${data.cart_count})`;
                }

                // Update discount percentage if available
                if (data.discount_percentage) {
                    const discountText = document.querySelector('.discount-text');
                    if (discountText) {
                        discountText.textContent = `Discount (${data.discount_percentage}%)`;
                    }
                }
            }

            // Function to show notification
            function showNotification(message, isError = false) {
                const notification = document.createElement('div');
                notification.className = `notification ${isError ? 'error' : 'success'}`;
                notification.style.position = 'fixed';
                notification.style.top = '80px'; // Changed from 50% to fixed pixels from top
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)'; // Only transform X axis since we're using fixed top
                notification.style.padding = '20px 40px 20px 20px';
                notification.style.borderRadius = '8px';
                notification.style.backgroundColor = isError ? '#ff4444' : '#00C851';
                notification.style.color = 'white';
                notification.style.zIndex = '1000';
                notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                notification.style.minWidth = '300px';
                notification.style.display = 'flex';
                notification.style.justifyContent = 'space-between';
                notification.style.alignItems = 'center';

                // Create message span
                const messageSpan = document.createElement('span');
                messageSpan.textContent = message;
                messageSpan.style.flex = '1';
                notification.appendChild(messageSpan);

                // Create close button
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '√ó';
                closeButton.style.background = 'none';
                closeButton.style.border = 'none';
                closeButton.style.color = 'white';
                closeButton.style.fontSize = '24px';
                closeButton.style.cursor = 'pointer';
                closeButton.style.marginLeft = '15px';
                closeButton.style.padding = '0 5px';
                closeButton.style.lineHeight = '1';
                closeButton.style.opacity = '0.8';
                closeButton.style.transition = 'opacity 0.2s';
                
                // Hover effect
                closeButton.addEventListener('mouseover', () => {
                    closeButton.style.opacity = '1';
                });
                closeButton.addEventListener('mouseout', () => {
                    closeButton.style.opacity = '0.8';
                });

                // Click handler
                closeButton.addEventListener('click', () => {
                    notification.remove();
                });

                notification.appendChild(closeButton);
                document.body.appendChild(notification);

                // Auto-remove after 5 seconds if not manually closed
                const timeout = setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.remove();
                    }
                }, 5000);

                // Clear timeout if manually closed
                closeButton.addEventListener('click', () => {
                    clearTimeout(timeout);
                });

                // Add fade-in animation from top
                notification.animate([
                    { opacity: 0, transform: 'translate(-50%, -20px)' },
                    { opacity: 1, transform: 'translateX(-50%)' }
                ], {
                    duration: 300,
                    easing: 'ease-out'
                });
            }

            // Handle quantity changes
            document.querySelectorAll('.quantity-input').forEach(input => {
                let previousValue = input.value;
                
                input.addEventListener('change', function(event) {
                    event.preventDefault();
                    const quantity = parseInt(this.value, 10) || 1;
                    if (quantity < 1) {
                        this.value = 1;
                        return;
                    }

                const productId = this.getAttribute('data-product-id');
                const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                    // Show loading state
                    const cartItem = this.closest('.cart-item');
                    if (cartItem) {
                        cartItem.style.opacity = '0.5';
                    }

                fetch('/cart/update/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `product_id=${productId}&quantity=${quantity}`
                })
                .then(response => response.json())
                .then(data => {
                        if (cartItem) {
                            cartItem.style.opacity = '1';
                        }
                        
                        if (data.success) {
                            // Update all UI elements with server data
                            updateCartUI(data);
                            previousValue = quantity;
                            showNotification('Cart updated successfully');
                    } else {
                            showNotification(data.error || 'Failed to update cart', true);
                            this.value = previousValue;
                            // Revert UI changes
                            updateCartUI(data);
                        }
                    })
                    .catch(error => {
                        if (cartItem) {
                            cartItem.style.opacity = '1';
                        }
                        console.error('Error updating cart:', error);
                        showNotification('Error updating cart', true);
                        this.value = previousValue;
                        // Revert UI changes
                        const currentItem = this.closest('.cart-item');
                        if (currentItem) {
                            const unitPrice = safeParseFloat(this.getAttribute('data-unit-price'));
                            updateItemPrice(currentItem, previousValue, unitPrice);
                        }
                });
            });
        });

            // Handle remove buttons
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                const cartItem = this.closest('.cart-item');
                    const productId = cartItem.querySelector('.quantity-input').getAttribute('data-product-id');
                    
                    // Show loading state
                    cartItem.style.opacity = '0.5';

                const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                    fetch('/cart/update/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                        body: `product_id=${productId}&quantity=0`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cartItem.remove();
                            updateCartUI(data);
                            showNotification('Item removed from cart');
                    } else {
                            cartItem.style.opacity = '1';
                            showNotification(data.error || 'Failed to remove item', true);
                        }
                    })
                    .catch(error => {
                        cartItem.style.opacity = '1';
                        console.error('Error removing item:', error);
                        showNotification('Error removing item', true);
                    });
            });
        });

            // Update the save-btn click handler in your JavaScript
            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    const cartItem = this.closest('.cart-item');
                    const productId = cartItem.getAttribute('data-product-id');
                    const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                    // Show loading state
                    cartItem.style.opacity = '0.5';

                    // First add to wishlist
                    fetch('/wishlist/add/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `product_id=${productId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Then remove from cart
                            return fetch('/cart/update/', {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': csrfToken,
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                },
                                body: `product_id=${productId}&quantity=0`
                            });
                        } else {
                            throw new Error(data.error || 'Failed to add to wishlist');
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showNotification('Item saved to wishlist');
                            // Reload the page to show updated cart and wishlist
                            window.location.reload();
                        } else {
                            cartItem.style.opacity = '1';
                            showNotification(data.error || 'Failed to update cart', true);
                        }
                    })
                    .catch(error => {
                        cartItem.style.opacity = '1';
                        console.error('Error:', error);
                        showNotification(error.message || 'Error saving item', true);
                    });
            });
        });

            // Handle coupon application
            const applyButton = document.querySelector('.apply-btn');
            const couponInput = document.querySelector('.coupon-input');
            
            if (applyButton && couponInput) {
                applyButton.addEventListener('click', function(event) {
                    event.preventDefault();
                    const code = couponInput.value.trim();
                    if (code) {
                        const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                        // Show loading state
                        applyButton.disabled = true;
                        applyButton.textContent = 'Applying...';

                        fetch('/cart/apply-coupon/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `code=${code}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            applyButton.disabled = false;
                            applyButton.textContent = 'Apply';
                            
                            if (data.success) {
                                updateCartUI(data);
                                showNotification('Coupon applied successfully');
                couponInput.value = '';
                            } else {
                                showNotification(data.error || 'Invalid coupon code', true);
                            }
                        })
                        .catch(error => {
                            applyButton.disabled = false;
                            applyButton.textContent = 'Apply';
                            console.error('Error applying coupon:', error);
                            showNotification('Error applying coupon', true);
                        });
                    } else {
                        showNotification('Please enter a coupon code', true);
                    }
                });
            }

            // Initialize cart UI with current values
            updateCartUI({
                subtotal: parseFloat('{{ subtotal|floatformat:2 }}'),
                tax: parseFloat('{{ tax|floatformat:2 }}'),
                discount: parseFloat('{{ discount|floatformat:2 }}'),
                total: parseFloat('{{ total|floatformat:2 }}'),
                cart_count: parseInt('{{ cart_items|length }}'),
                discount_percentage: parseFloat('{{ discount_percentage|default:10 }}')
            });

            // Handle "Move to cart" button clicks
            document.querySelectorAll('.move-to-cart-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    const productId = this.getAttribute('data-product-id');
                    if (!productId) {
                        showNotification('Error: Product ID not found', true);
                        return;
                    }

                    const savedItem = this.closest('.saved-item');
                    if (!savedItem) {
                        showNotification('Error: Could not find item to move', true);
                        return;
                    }

                    // Show loading state
                    this.disabled = true;
                    savedItem.style.opacity = '0.5';

                    const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                    // First, add to cart
                    fetch('/cart/update/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: `product_id=${productId}&quantity=1`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Then remove from wishlist
                            return fetch('/wishlist/remove/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'X-CSRFToken': csrfToken
                                },
                                body: `product_id=${productId}`
                            });
                        } else {
                            throw new Error(data.error || 'Failed to add item to cart');
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page to show updated cart and wishlist
                            window.location.reload();
                        } else {
                            // Reset loading state
                            this.disabled = false;
                            savedItem.style.opacity = '1';
                            showNotification(data.error || 'Failed to move item to cart', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Reset loading state
                        this.disabled = false;
                        savedItem.style.opacity = '1';
                        showNotification(error.message || 'Error moving item to cart', true);
                    });
                });
            });

            // Handle "Remove from wishlist" button clicks
            document.querySelectorAll('.remove-from-wishlist-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    const productId = this.getAttribute('data-product-id');
                    if (!productId) {
                        showNotification('Error: Product ID not found', true);
                        return;
                    }

                    const savedItem = this.closest('.saved-item');
                    if (!savedItem) {
                        showNotification('Error: Could not find item to remove', true);
                        return;
                    }

                    // Show loading state
                    this.disabled = true;
                    savedItem.style.opacity = '0.5';

                    const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;

                    fetch('/wishlist/remove/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken
                        },
                        body: `product_id=${productId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the item from DOM
                            savedItem.remove();
                            showNotification('Item removed from wishlist');

                            // Check if wishlist is empty
                            const remainingItems = document.querySelectorAll('.saved-item');
                            if (remainingItems.length === 0) {
                                const savedItemsGrid = document.querySelector('.saved-items-grid');
                                if (savedItemsGrid) {
                                    savedItemsGrid.innerHTML = `
                                        <div class="empty-wishlist">
                                            <p>No items saved for later</p>
                                        </div>
                                    `;
                                }
                            }
            } else {
                            // Reset loading state
                            this.disabled = false;
                            savedItem.style.opacity = '1';
                            showNotification(data.error || 'Failed to remove item from wishlist', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Reset loading state
                        this.disabled = false;
                        savedItem.style.opacity = '1';
                        showNotification('Error removing item from wishlist', true);
                    });
                });
            });

            // Handle "Remove all" button click
            const removeAllBtn = document.querySelector('.remove-all-btn');
            if (removeAllBtn) {
                removeAllBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    if (!confirm('Are you sure you want to remove all items from your cart?')) {
                        return;
                    }

                    const csrfToken = document.querySelector('#csrf-form input[name=csrfmiddlewaretoken]').value;
                    
                    // Show loading state
                    removeAllBtn.disabled = true;
                    removeAllBtn.style.opacity = '0.5';
                    
                    fetch('/cart/remove-all/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page to show proper empty state
                            window.location.reload();
            } else {
                            removeAllBtn.disabled = false;
                            removeAllBtn.style.opacity = '1';
                            showNotification(data.error || 'Failed to remove items', true);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        removeAllBtn.disabled = false;
                        removeAllBtn.style.opacity = '1';
                        showNotification('Error removing items', true);
                    });
                });
            }
        });
    </script>
{% endblock %}

</body>
</html>