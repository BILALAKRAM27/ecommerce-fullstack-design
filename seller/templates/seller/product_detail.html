<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }} - {{ seller.shop_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .product-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .product-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .product-image-section {
            text-align: center;
        }

        .product-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            object-fit: contain;
            border: 2px solid #e1e5e9;
            background: #f8f9fa;
        }

        .no-image {
            width: 100%;
            height: 300px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 1.1rem;
            background: #f8f9fa;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-section {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 15px;
        }

        .info-section:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            color: #666;
            font-size: 1.1rem;
        }

        .product-name {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }

        .product-category {
            color: #667eea;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .price-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .price-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .final-price {
            font-size: 2rem;
            font-weight: 700;
            color: #28a745;
        }

        .base-price {
            font-size: 1.2rem;
            color: #6c757d;
            text-decoration: line-through;
        }

        .discount-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .stock-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stock-available {
            background: #d4edda;
            color: #155724;
        }

        .stock-low {
            background: #fff3cd;
            color: #856404;
        }

        .stock-out {
            background: #f8d7da;
            color: #721c24;
        }

        .description {
            line-height: 1.6;
            color: #666;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .attribute-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .attribute-label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .attribute-value {
            color: #666;
            font-size: 1rem;
        }

        .attribute-unit {
            color: #999;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            .product-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .metrics {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 32px; /* More pronounced roundness */
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 32px 32px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(90vh - 140px); /* Account for header and footer */
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-radius: 0 0 32px 32px;
        }

        .modal-footer .btn {
            padding: 12px 24px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-footer .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .modal-footer .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .modal-footer .btn-secondary {
            background: #6c757d;
            border: none;
            color: white;
        }

        .modal-footer .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .modal-footer .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .modal-footer .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .warning-box h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-box ul {
            color: #856404;
            margin: 0;
            padding-left: 20px;
        }

        .warning-box li {
            margin-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .errorlist {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            list-style: none;
            padding: 0;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            object-fit: contain;
            border: 2px solid #e1e5e9;
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .attribute-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e1e5e9;
        }

        .attribute-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .attribute-group {
            margin-bottom: 15px;
        }

        .attribute-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .attribute-required {
            color: #e74c3c;
            font-size: 0.8rem;
        }

        .attribute-unit {
            color: #666;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="product-container">
            <div class="header">
                <h1>{{ product.name }}</h1>
                <div class="header-actions">
                    <a href="{% url 'seller:product_list' %}" class="btn btn-primary">Back to Products</a>
                    <button onclick="openUpdateModal({{ product.id }}, '{{ product.name|escapejs }}')" class="btn btn-primary">Edit Product</button>
                    <button onclick="openDeleteModal({{ product.id }}, '{{ product.name|escapejs }}')" class="btn btn-danger">Delete</button>
                </div>
            </div>

            <div class="product-content">
                <div class="product-image-section">
                    {% if product.get_image_base64 %}
                    <img src="data:image/jpeg;base64,{{ product.get_image_base64 }}" alt="{{ product.name }}" class="product-image">
                    {% else %}
                    <div class="no-image">No Image Available</div>
                    {% endif %}
                </div>

                <div class="product-info">
                    <div class="info-section">
                        <h2 class="product-name">{{ product.name }}</h2>
                        <div class="product-category">{{ product.category.name }}</div>
                        {% if product.brand %}
                        <div class="info-label">Brand</div>
                        <div class="info-value">{{ product.brand.name }}</div>
                        {% endif %}
                    </div>

                    <div class="price-section">
                        <div class="price-display">
                            {% if product.final_price %}
                            <span class="final-price">${{ product.final_price|floatformat:2 }}</span>
                            {% if product.discount_percentage %}
                            <span class="base-price">${{ product.base_price|floatformat:2 }}</span>
                            <span class="discount-badge">{{ product.discount_percentage }}% OFF</span>
                            {% endif %}
                            {% else %}
                            <span class="final-price">${{ product.base_price|floatformat:2 }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">Condition</div>
                        <div class="info-value">{{ product.condition|title }}</div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">Stock Status</div>
                        <div class="info-value">
                            {% if product.stock > 10 %}
                            <span class="stock-status stock-available">{{ product.stock }} units available</span>
                            {% elif product.stock > 0 %}
                            <span class="stock-status stock-low">Only {{ product.stock }} units left</span>
                            {% else %}
                            <span class="stock-status stock-out">Out of stock</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if product.description %}
                    <div class="info-section">
                        <div class="info-label">Description</div>
                        <div class="description">{{ product.description }}</div>
                    </div>
                    {% endif %}

                    <!-- Dynamic Attributes -->
                    {% if product.attribute_values.all %}
                    <div class="info-section">
                        <div class="info-label">Product Specifications</div>
                        <div class="attributes-grid">
                            {% for attr_value in product.attribute_values.all %}
                            <div class="attribute-item">
                                <span class="attribute-label">{{ attr_value.attribute.name }}:</span>
                                <span class="attribute-value">{{ attr_value.value }}</span>
                                {% if attr_value.attribute.unit %}
                                <span class="attribute-unit">{{ attr_value.attribute.unit }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-value">{{ product.order_count }}</div>
                            <div class="metric-label">Orders</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value">
                                {% if product.rating_avg %}
                                {{ product.rating_avg|floatformat:1 }}/5
                                {% else %}
                                N/A
                                {% endif %}
                            </div>
                            <div class="metric-label">Rating</div>
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">Created</div>
                        <div class="info-value">{{ product.created_at|date:"F j, Y" }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Product Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Update Product</h3>
                <span class="close" onclick="closeUpdateModal()">&times;</span>
            </div>
            <form method="POST" enctype="multipart/form-data" id="updateForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div id="updateFormContent">
                        <!-- Dynamic form content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeUpdateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Product Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Delete Product</h3>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <form method="POST" id="deleteForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="warning-box">
                        <h4>⚠️ Warning</h4>
                        <ul>
                            <li>This action will permanently delete the product</li>
                            <li>All product information will be lost</li>
                            <li>This action cannot be undone</li>
                        </ul>
                    </div>
                    <p>Are you sure you want to delete <strong id="deleteProductName"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button type="submit" class="btn btn-danger">Yes, Delete Product</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentCategoryId = null;
        let attributesData = [];
        let currentProductId = null;

        // DOM elements
        const updateModal = document.getElementById('updateModal');
        const deleteModal = document.getElementById('deleteModal');
        const updateFormContent = document.getElementById('updateFormContent');
        const deleteProductName = document.getElementById('deleteProductName');
        const updateForm = document.getElementById('updateForm');
        const deleteForm = document.getElementById('deleteForm');

        // Handle update form submission
        updateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(updateForm);
            formData.append('product_id', currentProductId);
            
            fetch(`{% url 'sellers:product_update' 0 %}`.replace('0', currentProductId), {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    closeUpdateModal();
                    location.reload(); // Refresh the page to show updated data
                } else {
                    console.error('Update failed');
                }
            })
            .catch(error => {
                console.error('Error updating product:', error);
            });
        });

        // Modal functions
        function openUpdateModal(productId, productName) {
            currentProductId = productId;
            updateFormContent.innerHTML = '<div class="loading">Loading product form...</div>';
            updateModal.style.display = 'block';
            
            // Load the update form via AJAX
            fetch(`{% url 'sellers:product_update_form' 0 %}`.replace('0', productId), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                updateFormContent.innerHTML = html;
                initializeUpdateForm();
            })
            .catch(error => {
                console.error('Error loading update form:', error);
                updateFormContent.innerHTML = '<div style="color: #e74c3c;">Error loading form</div>';
            });
        }

        function closeUpdateModal() {
            updateModal.style.display = 'none';
            updateFormContent.innerHTML = '';
        }

        function openDeleteModal(productId, productName) {
            currentProductId = productId;
            deleteProductName.textContent = productName;
            deleteForm.action = `{% url 'sellers:product_delete' 0 %}`.replace('0', productId);
            deleteModal.style.display = 'block';
        }

        function closeDeleteModal() {
            deleteModal.style.display = 'none';
        }

        // Initialize update form with dynamic functionality
        function initializeUpdateForm() {
            const parentCategorySelect = document.getElementById('parent_category');
            const childCategorySelect = document.getElementById('child_category');
            const finalCategorySelect = document.getElementById('id_category');
            const attributesSection = document.getElementById('attributesSection');
            const attributesContainer = document.getElementById('attributesContainer');

            if (parentCategorySelect) {
                parentCategorySelect.addEventListener('change', handleParentCategoryChange);
            }
            if (childCategorySelect) {
                childCategorySelect.addEventListener('change', handleChildCategoryChange);
            }
            if (finalCategorySelect) {
                finalCategorySelect.addEventListener('change', handleFinalCategoryChange);
            }

            // Auto-calculate final price
            const basePriceField = document.getElementById('id_base_price');
            const discountField = document.getElementById('id_discount_percentage');
            const finalPriceField = document.getElementById('id_final_price');

            if (basePriceField && discountField && finalPriceField) {
                function calculateFinalPrice() {
                    const basePrice = parseFloat(basePriceField.value) || 0;
                    const discount = parseFloat(discountField.value) || 0;
                    
                    if (basePrice > 0 && discount > 0) {
                        const finalPrice = basePrice * (1 - discount / 100);
                        finalPriceField.value = finalPrice.toFixed(2);
                    }
                }

                basePriceField.addEventListener('input', calculateFinalPrice);
                discountField.addEventListener('input', calculateFinalPrice);
            }

            // Initialize image preview
            initializeImagePreview();
        }

        // Handle parent category change
        function handleParentCategoryChange() {
            const parentCategorySelect = document.getElementById('parent_category');
            const childCategorySelect = document.getElementById('child_category');
            const finalCategorySelect = document.getElementById('id_category');
            const attributesSection = document.getElementById('attributesSection');
            
            const parentId = parentCategorySelect.value;
            
            // Reset child category
            childCategorySelect.innerHTML = '<option value="">Select Child Category (if any)</option>';
            childCategorySelect.disabled = !parentId;
            
            // Reset final category
            finalCategorySelect.innerHTML = '<option value="">Select Final Category</option>';
            finalCategorySelect.disabled = true;
            
            // Hide attributes section
            if (attributesSection) {
                attributesSection.style.display = 'none';
            }
            
            if (parentId) {
                // Load child categories
                loadChildCategories(parentId);
            }
        }

        // Handle child category change
        function handleChildCategoryChange() {
            const childCategorySelect = document.getElementById('child_category');
            const parentCategorySelect = document.getElementById('parent_category');
            const finalCategorySelect = document.getElementById('id_category');
            
            const childId = childCategorySelect.value;
            const parentId = parentCategorySelect.value;
            
            // Reset final category
            finalCategorySelect.innerHTML = '<option value="">Select Final Category</option>';
            
            if (childId) {
                // Set final category to child
                setFinalCategory(childId, childCategorySelect.options[childCategorySelect.selectedIndex].text);
            } else if (parentId) {
                // Set final category to parent
                setFinalCategory(parentId, parentCategorySelect.options[parentCategorySelect.selectedIndex].text);
            }
        }

        // Handle final category change
        function handleFinalCategoryChange() {
            const finalCategorySelect = document.getElementById('id_category');
            const attributesSection = document.getElementById('attributesSection');
            
            const categoryId = finalCategorySelect.value;
            
            if (categoryId) {
                currentCategoryId = categoryId;
                loadCategoryAttributes(categoryId);
            } else {
                if (attributesSection) {
                    attributesSection.style.display = 'none';
                }
            }
        }

        // Load child categories via AJAX
        function loadChildCategories(parentId) {
            const childCategorySelect = document.getElementById('child_category');
            const parentCategorySelect = document.getElementById('parent_category');
            const finalCategorySelect = document.getElementById('id_category');
            
            fetch('{% url "sellers:get_category_children" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ parent_id: parentId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.children.length > 0) {
                    data.children.forEach(child => {
                        const option = document.createElement('option');
                        option.value = child.id;
                        option.textContent = child.name;
                        childCategorySelect.appendChild(option);
                    });
                    childCategorySelect.disabled = false;
                } else {
                    // No children, set parent as final category
                    setFinalCategory(parentId, parentCategorySelect.options[parentCategorySelect.selectedIndex].text);
                }
            })
            .catch(error => {
                console.error('Error loading child categories:', error);
            });
        }

        // Set final category
        function setFinalCategory(categoryId, categoryName) {
            const finalCategorySelect = document.getElementById('id_category');
            
            finalCategorySelect.innerHTML = '<option value="">Select Final Category</option>';
            
            const option = document.createElement('option');
            option.value = categoryId;
            option.textContent = categoryName;
            finalCategorySelect.appendChild(option);
            
            finalCategorySelect.value = categoryId;
            finalCategorySelect.disabled = false;
            
            // Trigger change event to load attributes
            finalCategorySelect.dispatchEvent(new Event('change'));
        }

        // Load category attributes via AJAX
        function loadCategoryAttributes(categoryId) {
            const attributesSection = document.getElementById('attributesSection');
            const attributesContainer = document.getElementById('attributesContainer');
            
            // Show loading
            if (attributesSection) {
                attributesSection.style.display = 'block';
            }
            if (attributesContainer) {
                attributesContainer.innerHTML = '<div class="loading">Loading attributes...</div>';
            }
            
            console.log('Loading attributes for category:', categoryId);
            
            fetch('{% url "sellers:get_category_attributes" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ category_id: categoryId })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received attributes data:', data);
                attributesData = data.attributes;
                renderAttributes(data.attributes);
            })
            .catch(error => {
                console.error('Error loading attributes:', error);
                if (attributesContainer) {
                    attributesContainer.innerHTML = '<div style="color: #e74c3c;">Error loading attributes</div>';
                }
            });
        }

        // Render attributes
        function renderAttributes(attributes) {
            const attributesContainer = document.getElementById('attributesContainer');
            
            if (!attributesContainer) return;
            
            console.log('Rendering attributes:', attributes);
            
            if (attributes.length === 0) {
                attributesContainer.innerHTML = '<div style="color: #666;">No attributes found for this category</div>';
                return;
            }

            let html = '';
            attributes.forEach(attr => {
                console.log('Rendering attribute:', attr.name, 'with options:', attr.options);
                html += `
                    <div class="attribute-group">
                        <div class="attribute-label">
                            ${attr.name}
                            ${attr.is_required ? '<span class="attribute-required">*</span>' : ''}
                            ${attr.unit ? `<span class="attribute-unit">(${attr.unit})</span>` : ''}
                        </div>
                        ${renderAttributeInput(attr)}
                    </div>
                `;
            });
            
            attributesContainer.innerHTML = html;
        }

        // Render attribute input based on type
        function renderAttributeInput(attr) {
            const inputName = `attribute_${attr.id}`;
            const required = attr.is_required ? 'required' : '';
            
            console.log('Rendering input for attribute:', attr.name, 'type:', attr.input_type, 'options:', attr.options);
            
            switch (attr.input_type) {
                case 'dropdown':
                    let options = '<option value="">Select ' + attr.name + '</option>';
                    attr.options.forEach(option => {
                        console.log('Adding dropdown option:', option.value);
                        options += `<option value="${option.value}">${option.value}</option>`;
                    });
                    return `<select name="${inputName}" ${required} class="form-control">${options}</select>`;
                
                case 'number':
                    return `<input type="number" name="${inputName}" ${required} class="form-control" placeholder="Enter ${attr.name}">`;
                
                case 'boolean':
                    return `<select name="${inputName}" ${required} class="form-control">
                        <option value="">Select ${attr.name}</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>`;
                
                default: // text
                    let inputHtml = `<input type="text" name="${inputName}" ${required} class="form-control" placeholder="Enter ${attr.name}" list="options_${attr.id}">`;
                    
                    // Add datalist for existing options
                    if (attr.options.length > 0) {
                        console.log('Adding datalist with options for:', attr.name);
                        inputHtml += `<datalist id="options_${attr.id}">`;
                        attr.options.forEach(option => {
                            console.log('Adding datalist option:', option.value);
                            inputHtml += `<option value="${option.value}">`;
                        });
                        inputHtml += `</datalist>`;
                    } else {
                        console.log('No options found for attribute:', attr.name);
                    }
                    
                    return inputHtml;
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target === updateModal) {
                closeUpdateModal();
            }
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        }

        // Initialize image preview functionality
        function initializeImagePreview() {
            const imageInput = document.getElementById('id_image');
            if (!imageInput) return;

            // Create preview container if it doesn't exist
            let previewContainer = document.getElementById('image-preview-container');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'image-preview-container';
                previewContainer.className = 'image-preview-container';
                previewContainer.style.cssText = `
                    margin-top: 15px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                imageInput.parentNode.appendChild(previewContainer);
            }

            // Remove current image preview - only show new image preview

            // Create new image section
            const newImageSection = document.createElement('div');
            newImageSection.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 150px;
            `;

            const newImageLabel = document.createElement('div');
            newImageLabel.textContent = 'New Image Preview';
            newImageLabel.style.cssText = `
                font-size: 0.9rem;
                color: #667eea;
                margin-bottom: 10px;
                font-weight: 600;
                text-align: center;
            `;
            newImageSection.appendChild(newImageLabel);

            const newImagePlaceholder = document.createElement('div');
            newImagePlaceholder.style.cssText = `
                width: 150px;
                height: 150px;
                border: 2px dashed #667eea;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #667eea;
                font-size: 0.9rem;
            `;
            newImagePlaceholder.textContent = 'Select Image';
            newImageSection.appendChild(newImagePlaceholder);

            const fileInfo = document.createElement('div');
            fileInfo.id = 'file-info';
            fileInfo.style.cssText = `
                font-size: 0.8rem;
                color: #666;
                margin-top: 10px;
                text-align: center;
                min-height: 20px;
            `;
            newImageSection.appendChild(fileInfo);

            previewContainer.appendChild(newImageSection);

            // Handle new image selection
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    newImagePlaceholder.innerHTML = '<div style="color: #e74c3c;">Invalid file type</div>';
                    fileInfo.textContent = '';
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    newImagePlaceholder.innerHTML = '<div style="color: #e74c3c;">File too large</div>';
                    fileInfo.textContent = '';
                    return;
                }

                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    newImagePlaceholder.innerHTML = '';
                                    const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Selected Image Preview';
                img.style.cssText = `
                    width: 150px;
                    height: 150px;
                    border-radius: 8px;
                    border: 2px solid #667eea;
                    object-fit: contain;
                `;
                newImagePlaceholder.appendChild(img);
                    
                    fileInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                };
                reader.readAsDataURL(file);
            });
        }

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUpdateModal();
                closeDeleteModal();
            }
        });
    </script>
</body>
</html> 