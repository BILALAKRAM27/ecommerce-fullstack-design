{% load b64filters %}
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - {{ seller.shop_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .messages {
            margin-bottom: 20px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #e74c3c;
        }

        .errorlist {
            color: #e74c3c;
            font-size: 0.85rem;
            margin-top: 5px;
            list-style: none;
            padding: 0;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            object-fit: contain;
            border: 2px solid #e1e5e9;
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .attribute-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #e1e5e9;
        }

        .attribute-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .attribute-group {
            margin-bottom: 15px;
        }

        .attribute-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .attribute-required {
            color: #e74c3c;
            font-size: 0.8rem;
        }

        .attribute-unit {
            color: #666;
            font-size: 0.8rem;
            margin-left: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <!-- Django Messages -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-container">
            <div class="header">
                <h1>{{ title }}</h1>
                <p>Fill in the details below to {{ title|lower }} your product</p>
            </div>

            <form method="post" enctype="multipart/form-data" id="dynamicProductForm">
                {% csrf_token %}
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.name.id_for_label }}">Product Name *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                        <ul class="errorlist">
                            {% for error in form.name.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.brand.id_for_label }}">Brand</label>
                        {{ form.brand }}
                        {% if form.brand.errors %}
                        <ul class="errorlist">
                            {% for error in form.brand.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <!-- Category Selection -->
                {% if parent_categories %}
                <div class="form-row">
                    <div class="form-group">
                        <label for="parent_category">Parent Category *</label>
                        <select id="parent_category" name="parent_category" required>
                            <option value="">Select Parent Category</option>
                            {% for category in parent_categories %}
                            <option value="{{ category.id }}" {% if current_parent_category and current_parent_category.id == category.id %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="child_category">Child Category</label>
                        <select id="child_category" name="child_category">
                            <option value="">Select Child Category (if any)</option>
                            {% if current_child_category %}
                            <option value="{{ current_child_category.id }}" selected>{{ current_child_category.name }}</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <!-- Final Category Selection -->
                <div class="form-group">
                    <label for="{{ form.category.id_for_label }}">Final Category *</label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <ul class="errorlist">
                        {% for error in form.category.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>

                <!-- Dynamic Attributes Section -->
                <div id="attributesSection" class="attribute-section" style="display: none;">
                    <h3>Product Attributes</h3>
                    <div id="attributesContainer">
                        <!-- Dynamic attributes will be loaded here -->
                    </div>
                </div>
                {% endif %}

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.condition.id_for_label }}">Condition *</label>
                        {{ form.condition }}
                        {% if form.condition.errors %}
                        <ul class="errorlist">
                            {% for error in form.condition.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="{{ form.description.id_for_label }}">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <ul class="errorlist">
                        {% for error in form.description.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.base_price.id_for_label }}">Base Price *</label>
                        {{ form.base_price }}
                        <div class="help-text">Enter the original price of the product</div>
                        {% if form.base_price.errors %}
                        <ul class="errorlist">
                            {% for error in form.base_price.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.discount_percentage.id_for_label }}">Discount Percentage</label>
                        {{ form.discount_percentage }}
                        <div class="help-text">Enter discount as percentage (e.g., 10 for 10%)</div>
                        {% if form.discount_percentage.errors %}
                        <ul class="errorlist">
                            {% for error in form.discount_percentage.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.final_price.id_for_label }}">Final Price</label>
                        {{ form.final_price }}
                        <div class="help-text">Will be calculated automatically if discount is provided</div>
                        {% if form.final_price.errors %}
                        <ul class="errorlist">
                            {% for error in form.final_price.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.stock.id_for_label }}">Stock Quantity *</label>
                        {{ form.stock }}
                        {% if form.stock.errors %}
                        <ul class="errorlist">
                            {% for error in form.stock.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="id_image_file">Product Images</label>
                    <input type="file" name="image_file" id="id_image_file" multiple onchange="previewImages(event)">
                    <div id="imagePreviews"></div>
                    <div id="thumbnailSelector" style="margin-top:10px;"></div>
                    {% if product and product.images.all %}
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        {% for img in product.images.all %}
                            <div style="display: flex; flex-direction: column; align-items: center;">
                                <img src="data:image/jpeg;base64,{{ img.image|b64encode }}" alt="Product Image" class="image-preview">
                                <input type="radio" name="existing_thumbnail" value="{{ img.id }}" {% if img.is_thumbnail %}checked{% endif %}> Thumbnail
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if form.images.errors %}
                    <ul class="errorlist">
                        {% for error in form.images.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
                {% if product and product.unique_id %}
                <div class="form-group full-width">
                    <label>Product Unique ID</label>
                    <input type="text" value="{{ product.unique_id }}" readonly style="width:100%;background:#f8f9fa;color:#666;">
                </div>
                {% endif %}

                <div class="form-actions">
                    <a href="{% url 'sellers:product_list' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        {% if product %}Update Product{% else %}Create Product{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentCategoryId = null;
        let attributesData = [];

        // DOM elements
        const parentCategorySelect = document.getElementById('parent_category');
        const childCategorySelect = document.getElementById('child_category');
        const finalCategorySelect = document.getElementById('{{ form.category.id_for_label }}');
        const attributesSection = document.getElementById('attributesSection');
        const attributesContainer = document.getElementById('attributesContainer');

        // Event listeners
        if (parentCategorySelect) {
            parentCategorySelect.addEventListener('change', handleParentCategoryChange);
        }
        if (childCategorySelect) {
            childCategorySelect.addEventListener('change', handleChildCategoryChange);
        }
        if (finalCategorySelect) {
            finalCategorySelect.addEventListener('change', handleFinalCategoryChange);
        }

        // Handle parent category change
        function handleParentCategoryChange() {
            const parentId = parentCategorySelect.value;
            
            // Reset child category
            childCategorySelect.innerHTML = '<option value="">Select Child Category (if any)</option>';
            childCategorySelect.disabled = !parentId;
            
            // Reset final category
            finalCategorySelect.innerHTML = '<option value="">Select Final Category</option>';
            finalCategorySelect.disabled = true;
            
            // Hide attributes section
            attributesSection.style.display = 'none';
            
            if (parentId) {
                // Load child categories
                loadChildCategories(parentId);
            }
        }

        // Handle child category change
        function handleChildCategoryChange() {
            const childId = childCategorySelect.value;
            const parentId = parentCategorySelect.value;
            
            // Reset final category
            finalCategorySelect.innerHTML = '<option value="">Select Final Category</option>';
            
            if (childId) {
                // Set final category to child
                setFinalCategory(childId, childCategorySelect.options[childCategorySelect.selectedIndex].text);
            } else if (parentId) {
                // Set final category to parent
                setFinalCategory(parentId, parentCategorySelect.options[parentCategorySelect.selectedIndex].text);
            }
        }

        // Handle final category change
        function handleFinalCategoryChange() {
            const categoryId = finalCategorySelect.value;
            
            if (categoryId) {
                currentCategoryId = categoryId;
                loadCategoryAttributes(categoryId);
            } else {
                attributesSection.style.display = 'none';
            }
        }

        // Load child categories via AJAX
        function loadChildCategories(parentId) {
            fetch('{% url "sellers:get_category_children" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ parent_id: parentId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.children.length > 0) {
                    data.children.forEach(child => {
                        const option = document.createElement('option');
                        option.value = child.id;
                        option.textContent = child.name;
                        childCategorySelect.appendChild(option);
                    });
                    childCategorySelect.disabled = false;
                } else {
                    // No children, set parent as final category
                    setFinalCategory(parentId, parentCategorySelect.options[parentCategorySelect.selectedIndex].text);
                }
            })
            .catch(error => {
                console.error('Error loading child categories:', error);
            });
        }

        // Set final category
        function setFinalCategory(categoryId, categoryName) {
            finalCategorySelect.innerHTML = '<option value="">Select Final Category</option>';
            
            const option = document.createElement('option');
            option.value = categoryId;
            option.textContent = categoryName;
            finalCategorySelect.appendChild(option);
            
            finalCategorySelect.value = categoryId;
            finalCategorySelect.disabled = false;
            
            // Trigger change event to load attributes
            finalCategorySelect.dispatchEvent(new Event('change'));
        }

        // Load category attributes via AJAX
        function loadCategoryAttributes(categoryId) {
            // Show loading
            attributesSection.style.display = 'block';
            attributesContainer.innerHTML = '<div class="loading">Loading attributes...</div>';
            
            console.log('Loading attributes for category:', categoryId);
            
            fetch('{% url "sellers:get_category_attributes" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ category_id: categoryId })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received attributes data:', data);
                attributesData = data.attributes;
                renderAttributes(data.attributes);
            })
            .catch(error => {
                console.error('Error loading attributes:', error);
                attributesContainer.innerHTML = '<div style="color: #e74c3c;">Error loading attributes</div>';
            });
        }

        // Render attributes
        function renderAttributes(attributes) {
            console.log('Rendering attributes:', attributes);
            
            if (attributes.length === 0) {
                attributesContainer.innerHTML = '<div style="color: #666;">No attributes found for this category</div>';
                return;
            }

            let html = '';
            attributes.forEach(attr => {
                console.log('Rendering attribute:', attr.name, 'with options:', attr.options);
                html += `
                    <div class="attribute-group">
                        <div class="attribute-label">
                            ${attr.name}
                            ${attr.is_required ? '<span class="attribute-required">*</span>' : ''}
                            ${attr.unit ? `<span class="attribute-unit">(${attr.unit})</span>` : ''}
                        </div>
                        ${renderAttributeInput(attr)}
                    </div>
                `;
            });
            
            attributesContainer.innerHTML = html;
        }

        // Render attribute input based on type
        function renderAttributeInput(attr) {
            const inputName = `attribute_${attr.id}`;
            const required = attr.is_required ? 'required' : '';
            
            console.log('Rendering input for attribute:', attr.name, 'type:', attr.input_type, 'options:', attr.options);
            
            switch (attr.input_type) {
                case 'dropdown':
                    let options = '<option value="">Select ' + attr.name + '</option>';
                    attr.options.forEach(option => {
                        console.log('Adding dropdown option:', option.value);
                        options += `<option value="${option.value}">${option.value}</option>`;
                    });
                    return `<select name="${inputName}" ${required} class="form-control">${options}</select>`;
                
                case 'number':
                    return `<input type="number" name="${inputName}" ${required} class="form-control" placeholder="Enter ${attr.name}">`;
                
                case 'boolean':
                    return `<select name="${inputName}" ${required} class="form-control">
                        <option value="">Select ${attr.name}</option>
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>`;
                
                default: // text
                    let inputHtml = `<input type="text" name="${inputName}" ${required} class="form-control" placeholder="Enter ${attr.name}" list="options_${attr.id}">`;
                    
                    // Add datalist for existing options
                    if (attr.options.length > 0) {
                        console.log('Adding datalist with options for:', attr.name);
                        inputHtml += `<datalist id="options_${attr.id}">`;
                        attr.options.forEach(option => {
                            console.log('Adding datalist option:', option.value);
                            inputHtml += `<option value="${option.value}">`;
                        });
                        inputHtml += `</datalist>`;
                    } else {
                        console.log('No options found for attribute:', attr.name);
                    }
                    
                    return inputHtml;
            }
        }

        // Auto-calculate final price when discount changes
        document.addEventListener('DOMContentLoaded', function() {
            const basePriceField = document.getElementById('{{ form.base_price.id_for_label }}');
            const discountField = document.getElementById('{{ form.discount_percentage.id_for_label }}');
            const finalPriceField = document.getElementById('{{ form.final_price.id_for_label }}');

            function calculateFinalPrice() {
                const basePrice = parseFloat(basePriceField.value) || 0;
                const discount = parseFloat(discountField.value) || 0;
                
                if (basePrice > 0 && discount > 0) {
                    const finalPrice = basePrice * (1 - discount / 100);
                    finalPriceField.value = finalPrice.toFixed(2);
                }
            }

            basePriceField.addEventListener('input', calculateFinalPrice);
            discountField.addEventListener('input', calculateFinalPrice);
        });
    </script>
    <script>
function previewImages(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById('imagePreviews');
    const thumbnailSelector = document.getElementById('thumbnailSelector');
    previewContainer.innerHTML = '';
    thumbnailSelector.innerHTML = '';
    if (files.length > 0) {
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.style.display = 'inline-block';
                div.style.marginRight = '10px';
                div.style.textAlign = 'center';
                div.innerHTML = `<img src="${e.target.result}" alt="Preview" class="image-preview"><br><input type='radio' name='thumbnail' value='${i}' ${i===0?'checked':''}> Thumbnail`;
                previewContainer.appendChild(div);
            };
            reader.readAsDataURL(file);
        }
    }
}
</script>
</body>
</html> 