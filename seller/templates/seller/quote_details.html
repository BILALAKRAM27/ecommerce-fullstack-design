{% extends 'index.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
{% csrf_token %}
{% if messages %}
<div class="messages" id="django-messages">
  {% for message in messages %}
  <div class="message {{ message.tags }}" data-message-id="{{ message.tags }}">
    <span class="message-id">{{ message.tags }}</span>
    {{ message }}
  </div>
  {% endfor %}
</div>
<script>
  setTimeout(function() {
    var msg = document.getElementById('django-messages');
    if (msg) { msg.style.display = 'none'; }
  }, 7000);
</script>
{% endif %}
<div class="quote-details-container">
    <div class="quote-details-wrapper">
        <!-- Quote Request Details Card -->
        <div class="quote-details-card">
            <div class="quote-details-header">
                <div class="quote-details-header__content">
                    <div class="quote-details-header__icon">
                        <i class="fas fa-quote-left"></i>
                    </div>
                    <div class="quote-details-header__text">
                        <h1 class="quote-details-header__title">{{ quote_request.product_name }}</h1>
                        <p class="quote-details-header__subtitle">Quote Request Details</p>
                    </div>
                </div>
            </div>
            
            <div class="quote-details-body">
                <div class="quote-details-grid">
                    <div class="quote-details-info">
                        <h3 class="quote-details-section__title">Request Information</h3>
                        <div class="quote-details-info__list">
                            <div class="quote-details-info__item">
                                <i class="fas fa-user quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Buyer:</span>
                                <span class="quote-details-info__value">{{ quote_request.buyer.name }}</span>
                            </div>
                            <div class="quote-details-info__item">
                                <i class="fas fa-tags quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Category:</span>
                                <span class="quote-details-info__value">{{ quote_request.category.name }}</span>
                            </div>
                            <div class="quote-details-info__item">
                                <i class="fas fa-sort-numeric-up quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Quantity:</span>
                                <span class="quote-details-info__value">{{ quote_request.quantity }} {{ quote_request.get_unit_display }}</span>
                            </div>
                            <div class="quote-details-info__item">
                                <i class="fas fa-clock quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Urgency:</span>
                                <span class="quote-details-badge quote-details-badge--{{ quote_request.urgency }}">{{ quote_request.get_urgency_display }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="quote-details-info">
                        <h3 class="quote-details-section__title">Additional Details</h3>
                        <div class="quote-details-info__list">
                            {% if quote_request.budget_range %}
                            <div class="quote-details-info__item">
                                <i class="fas fa-dollar-sign quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Budget:</span>
                                <span class="quote-details-info__value">{{ quote_request.budget_range }}</span>
                            </div>
                            {% endif %}
                            {% if quote_request.delivery_deadline %}
                            <div class="quote-details-info__item">
                                <i class="fas fa-calendar quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Deadline:</span>
                                <span class="quote-details-info__value">{{ quote_request.delivery_deadline|date:"M d, Y" }}</span>
                            </div>
                            {% endif %}
                            <div class="quote-details-info__item">
                                <i class="fas fa-calendar-alt quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Posted:</span>
                                <span class="quote-details-info__value">{{ quote_request.created_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="quote-details-info__item">
                                <i class="fas fa-info-circle quote-details-info__icon"></i>
                                <span class="quote-details-info__label">Status:</span>
                                <span class="quote-details-badge quote-details-badge--{{ quote_request.status }}">{{ quote_request.get_status_display }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="quote-details-divider"></div>
                
                <div class="quote-details-description">
                    <h3 class="quote-details-section__title">Description</h3>
                    <p class="quote-details-description__text">{{ quote_request.description }}</p>
                </div>
            </div>
        </div>
        
        <!-- Seller Responses Section -->
        <div class="quote-responses-card">
            <div class="quote-responses-header">
                <div class="quote-responses-header__content">
                    <div class="quote-responses-header__icon">
                        <i class="fas fa-reply"></i>
                    </div>
                    <div class="quote-responses-header__text">
                        <h2 class="quote-responses-header__title">Seller Responses</h2>
                        <span class="quote-responses-count" id="responseCount">({{ quote_request.responses.count }})</span>
                    </div>
                </div>
                <div class="quote-responses-status">
                    <div class="quote-responses-status__indicator">
                        <div class="quote-responses-status__dot" id="statusDot"></div>
                        <span class="quote-responses-status__text" id="statusText">Live</span>
                    </div>
                    <div class="quote-responses-last-update" id="lastUpdate">
                        Just updated
                    </div>
                </div>
            </div>
            
            <div class="quote-responses-body">
                <!-- Loading indicator -->
                <div class="quote-responses-loading" id="responsesLoading" style="display: none;">
                    <div class="quote-responses-spinner"></div>
                    <span>Checking for new responses...</span>
                </div>
                
                <!-- Responses container -->
                <div class="quote-responses-grid" id="responsesContainer">
                    {% if quote_request.responses.all %}
                        {% for response in quote_request.responses.all %}
                        <div class="quote-response-card" data-response-id="{{ response.id }}">
                            <div class="quote-response-header">
                                <div class="quote-response-seller">
                                    <h4 class="quote-response-seller__name">{{ response.seller.shop_name }}</h4>
                                    <span class="quote-response-date">{{ response.created_at|date:"M d, Y" }}</span>
                                </div>
                                <div class="quote-response-price">
                                    <div class="quote-response-price__amount">${{ response.price }}</div>
                                    <span class="quote-response-price__unit">per unit</span>
                                </div>
                            </div>
                            
                            <div class="quote-response-body">
                                <div class="quote-response-details">
                                    <div class="quote-response-detail">
                                        <span class="quote-response-detail__label">Total Price</span>
                                        <span class="quote-response-detail__value">${{ response.total_price }}</span>
                                    </div>
                                    <div class="quote-response-detail">
                                        <span class="quote-response-detail__label">Delivery</span>
                                        <span class="quote-response-detail__value">{{ response.delivery_estimate }}</span>
                                    </div>
                                </div>
                                
                                {% if response.notes %}
                                <div class="quote-response-notes">
                                    <span class="quote-response-notes__label">Notes:</span>
                                    <p class="quote-response-notes__text">{{ response.notes }}</p>
                                </div>
                                {% endif %}
                                
                                <div class="quote-response-footer">
                                    <div class="quote-response-status">
                                        {% if response.is_accepted %}
                                            <span class="quote-details-badge quote-details-badge--accepted">Accepted</span>
                                        {% elif response.is_rejected %}
                                            <span class="quote-details-badge quote-details-badge--rejected">Rejected</span>
                                        {% else %}
                                            <span class="quote-details-badge quote-details-badge--pending">Pending</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if user_type == 'buyer' and not response.is_accepted and not response.is_rejected %}
                                    <div class="quote-response-actions">
                                        <button type="button" class="quote-btn quote-btn--accept" onclick="acceptQuote('{{ response.id }}')">
                                            <i class="fas fa-check"></i>
                                            Accept
                                        </button>
                                        <button type="button" class="quote-btn quote-btn--reject" onclick="rejectQuote('{{ response.id }}')">
                                            <i class="fas fa-times"></i>
                                            Reject
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="quote-responses-empty" id="emptyState">
                            <div class="quote-responses-empty__icon">
                                <i class="fas fa-reply"></i>
                            </div>
                            <h3 class="quote-responses-empty__title">No responses yet</h3>
                            <p class="quote-responses-empty__text">
                                {% if user_type == 'buyer' %}
                                    Sellers will respond to your quote request. You'll receive notifications when they do.
                                {% else %}
                                    This quote request is still waiting for responses from sellers.
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="quote-actions">
            <a href="{% if user_type == 'buyer' %}{% url 'sellers:buyer_quote_requests' %}{% else %}{% url 'sellers:seller_quotes_inbox' %}{% endif %}" 
               class="quote-btn quote-btn--secondary">
                <i class="fas fa-arrow-left"></i>
                Back to {% if user_type == 'buyer' %}My Quotes{% else %}Quotes Inbox{% endif %}
            </a>
            
            {% if user_type == 'buyer' and quote_request.status == 'accepted' %}
                <a href="{% url 'buyer:checkout_page' %}" class="quote-btn quote-btn--primary">
                    <i class="fas fa-shopping-cart"></i>
                    Proceed to Checkout
                </a>
            {% endif %}
        </div>
    </div>
</div>

{% block extra_css %}
<style>
/* Quote Details Page Styles */
.quote-details-container {
    min-height: 100vh;
    background: #ffffff;
    padding: 2rem 1rem;
}

.quote-details-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

/* Quote Details Card */
.quote-details-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.quote-details-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
}

.quote-details-header {
    background: linear-gradient(135deg, #4285F4 0%, #3367D6 100%);
    padding: 2rem;
    color: white;
}

.quote-details-header__content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.quote-details-header__icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.quote-details-header__title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
}

.quote-details-header__subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
    font-weight: 400;
}

.quote-details-body {
    padding: 2rem;
}

.quote-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    margin-bottom: 2rem;
}

.quote-details-section__title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 1.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quote-details-info__list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.quote-details-info__item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 0;
}

.quote-details-info__icon {
    width: 20px;
    color: #4285F4;
    flex-shrink: 0;
}

.quote-details-info__label {
    font-weight: 600;
    color: #4a5568;
    min-width: 80px;
}

.quote-details-info__value {
    color: #2d3748;
    font-weight: 500;
}

.quote-details-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.quote-details-badge--low { background: #c6f6d5; color: #22543d; }
.quote-details-badge--medium { background: #fef5e7; color: #744210; }
.quote-details-badge--high { background: #fed7d7; color: #742a2a; }
.quote-details-badge--urgent { background: #fed7d7; color: #742a2a; }
.quote-details-badge--pending { background: #e2e8f0; color: #4a5568; }
.quote-details-badge--responded { background: #bee3f8; color: #2a69ac; }
.quote-details-badge--accepted { background: #c6f6d5; color: #22543d; }
.quote-details-badge--rejected { background: #fed7d7; color: #742a2a; }

.quote-details-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
    margin: 2rem 0;
}

.quote-details-description__text {
    color: #4a5568;
    line-height: 1.6;
    font-size: 1rem;
    margin: 0;
}

/* Quote Responses Card */
.quote-responses-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.quote-responses-header {
    background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
    padding: 2rem;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.quote-responses-header__content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.quote-responses-header__icon {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.quote-responses-header__title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
}

.quote-responses-count {
    font-size: 1rem;
    opacity: 0.9;
    font-weight: 400;
}

.quote-responses-status {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
}

.quote-responses-status__indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quote-responses-status__dot {
    width: 8px;
    height: 8px;
    background: #00ff88;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.quote-responses-status__text {
    font-size: 0.875rem;
    font-weight: 500;
}

.quote-responses-last-update {
    font-size: 0.75rem;
    opacity: 0.8;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.quote-responses-body {
    padding: 2rem;
}

.quote-responses-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
    color: #4a5568;
}

.quote-responses-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #e2e8f0;
    border-top: 2px solid #4285F4;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.quote-responses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

/* Response Cards */
.quote-response-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.quote-response-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #4285F4, #2ECC71);
}

.quote-response-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    border-color: #cbd5e0;
}

.quote-response-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.quote-response-seller__name {
    font-size: 1.125rem;
    font-weight: 600;
    color: #2d3748;
    margin: 0 0 0.25rem 0;
}

.quote-response-date {
    font-size: 0.875rem;
    color: #718096;
}

.quote-response-price {
    text-align: right;
}

.quote-response-price__amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2ECC71;
    line-height: 1;
}

.quote-response-price__unit {
    font-size: 0.75rem;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.quote-response-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.quote-response-detail {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}

.quote-response-detail__label {
    display: block;
    font-size: 0.75rem;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.quote-response-detail__value {
    font-size: 1rem;
    font-weight: 600;
    color: #2d3748;
}

.quote-response-notes {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    margin-bottom: 1rem;
}

.quote-response-notes__label {
    font-size: 0.75rem;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
}

.quote-response-notes__text {
    color: #4a5568;
    margin: 0.5rem 0 0 0;
    line-height: 1.5;
}

.quote-response-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.quote-response-actions {
    display: flex;
    gap: 0.5rem;
}

/* Buttons */
.quote-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.quote-btn--primary {
    background: linear-gradient(135deg, #4285F4 0%, #3367D6 100%);
    color: white;
}

.quote-btn--primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
}

.quote-btn--secondary {
    background: #f7fafc;
    color: #4a5568;
    border: 1px solid #e2e8f0;
}

.quote-btn--secondary:hover {
    background: #edf2f7;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.quote-btn--accept {
    background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
}

.quote-btn--accept:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
}

.quote-btn--reject {
    background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
}

.quote-btn--reject:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.quote-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

/* Empty State */
.quote-responses-empty {
    text-align: center;
    padding: 4rem 2rem;
    color: #718096;
}

.quote-responses-empty__icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.5;
}

.quote-responses-empty__title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #4a5568;
    margin: 0 0 1rem 0;
}

.quote-responses-empty__text {
    font-size: 1rem;
    line-height: 1.6;
    max-width: 400px;
    margin: 0 auto;
}

/* Responsive Design */
@media (max-width: 768px) {
    .quote-details-container {
        padding: 1rem;
    }
    
    .quote-details-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .quote-details-header__title {
        font-size: 1.5rem;
    }
    
    .quote-responses-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .quote-responses-grid {
        grid-template-columns: 1fr;
    }
    
    .quote-response-details {
        grid-template-columns: 1fr;
    }
    
    .quote-response-footer {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .quote-actions {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .quote-details-body,
    .quote-responses-body {
        padding: 1rem;
    }
    
    .quote-details-header,
    .quote-responses-header {
        padding: 1.5rem;
    }
    
    .quote-response-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .quote-response-price {
        text-align: center;
    }
}

/* Animation for new responses */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.quote-response-card.new-response {
    animation: slideInUp 0.5s ease-out;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Dynamic Response Loading System
class QuoteResponseManager {
    constructor() {
        this.quoteId = parseInt('{{ quote_request.id }}');
        this.lastUpdateTime = new Date();
        this.pollInterval = 10000; // 10 seconds
        this.isPolling = false;
        this.init();
    }
    
    init() {
        this.startPolling();
        this.updateLastUpdateTime();
    }
    
    startPolling() {
        if (this.isPolling) return;
        
        this.isPolling = true;
        this.pollTimer = setInterval(() => {
            this.fetchResponses();
        }, this.pollInterval);
        
        // Initial fetch
        setTimeout(() => this.fetchResponses(), 2000);
    }
    
    stopPolling() {
        if (this.pollTimer) {
            clearInterval(this.pollTimer);
            this.isPolling = false;
        }
    }
    
    async fetchResponses() {
        const loadingElement = document.getElementById('responsesLoading');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        try {
            // Show loading indicator
            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }
            
            // Update status to fetching
            if (statusDot && statusText) {
                statusDot.style.background = '#ffc107';
                statusText.textContent = 'Updating...';
            }
            
            const response = await fetch(`/api/quote-responses/${this.quoteId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.updateResponses(data.responses);
                    this.updateResponseCount(data.count);
                    this.lastUpdateTime = new Date();
                    this.updateLastUpdateTime();
                    
                    // Update status to live
                    if (statusDot && statusText) {
                        statusDot.style.background = '#00ff88';
                        statusText.textContent = 'Live';
                    }
                } else {
                    console.error('API returned error:', data.error);
                    // Update status to error
                    if (statusDot && statusText) {
                        statusDot.style.background = '#ff4757';
                        statusText.textContent = 'Error';
                    }
                }
            } else {
                console.error('Failed to fetch responses:', response.statusText);
                
                // Update status to error
                if (statusDot && statusText) {
                    statusDot.style.background = '#ff4757';
                    statusText.textContent = 'Error';
                }
            }
        } catch (error) {
            console.error('Error fetching responses:', error);
            
            // Update status to error
            if (statusDot && statusText) {
                statusDot.style.background = '#ff4757';
                statusText.textContent = 'Error';
            }
        } finally {
            // Hide loading indicator
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    }
    
    updateResponses(responses) {
        const container = document.getElementById('responsesContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (!container) return;
        
        const existingResponseIds = new Set(
            Array.from(container.querySelectorAll('.quote-response-card'))
                .map(card => card.dataset.responseId)
        );
        
        if (responses.length === 0) {
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            container.innerHTML = this.getEmptyStateHTML();
            return;
        }
        
        // Hide empty state if it exists
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        responses.forEach(response => {
            const existingElement = container.querySelector(`[data-response-id="${response.id}"]`);
            
            if (!existingElement) {
                // New response - add it with animation
                const responseHTML = this.createResponseHTML(response);
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = responseHTML;
                const responseElement = tempDiv.firstElementChild;
                responseElement.classList.add('new-response');
                
                container.appendChild(responseElement);
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    responseElement.classList.remove('new-response');
                }, 500);
            } else {
                // Update existing response if status changed
                const currentStatus = existingElement.querySelector('.quote-details-badge').textContent.trim();
                const newStatus = this.getStatusBadge(response).replace(/<[^>]*>/g, '').trim();
                
                if (currentStatus !== newStatus) {
                    // Status changed - update the response
                    const responseHTML = this.createResponseHTML(response);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = responseHTML;
                    const newResponseElement = tempDiv.firstElementChild;
                    
                    // Add update animation
                    newResponseElement.classList.add('updated-response');
                    existingElement.replaceWith(newResponseElement);
                    
                    // Remove animation class after animation completes
                    setTimeout(() => {
                        newResponseElement.classList.remove('updated-response');
                    }, 500);
                }
            }
        });
    }
    
    createResponseHTML(response) {
        return `
            <div class="quote-response-card" data-response-id="${response.id}">
                <div class="quote-response-header">
                    <div class="quote-response-seller">
                        <h4 class="quote-response-seller__name">${response.seller_name}</h4>
                        <span class="quote-response-date">${this.formatDate(response.created_at)}</span>
                    </div>
                    <div class="quote-response-price">
                        <div class="quote-response-price__amount">${response.price}</div>
                        <span class="quote-response-price__unit">per unit</span>
                    </div>
                </div>
                
                <div class="quote-response-body">
                    <div class="quote-response-details">
                        <div class="quote-response-detail">
                            <span class="quote-response-detail__label">Total Price</span>
                            <span class="quote-response-detail__value">${response.total_price}</span>
                        </div>
                        <div class="quote-response-detail">
                            <span class="quote-response-detail__label">Delivery</span>
                            <span class="quote-response-detail__value">${response.delivery_estimate}</span>
                        </div>
                    </div>
                    
                    ${response.notes ? `
                    <div class="quote-response-notes">
                        <span class="quote-response-notes__label">Notes:</span>
                        <p class="quote-response-notes__text">${response.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div class="quote-response-footer">
                        <div class="quote-response-status">
                            ${this.getStatusBadge(response)}
                        </div>
                        
                        ${this.getActionButtons(response)}
                    </div>
                </div>
            </div>
        `;
    }
    
    getStatusBadge(response) {
        if (response.is_accepted) {
            return '<span class="quote-details-badge quote-details-badge--accepted">Accepted</span>';
        } else if (response.is_rejected) {
            return '<span class="quote-details-badge quote-details-badge--rejected">Rejected</span>';
        }
        return '<span class="quote-details-badge quote-details-badge--pending">Pending</span>';
    }
    
    getActionButtons(response) {
        const userType = '{{ user_type }}';
        
        // Show action buttons for buyers if the response is pending (not accepted or rejected)
        if (userType === 'buyer' && !response.is_accepted && !response.is_rejected) {
            return `
                <div class="quote-response-actions">
                    <button type="button" class="quote-btn quote-btn--accept" onclick="acceptQuote('${response.id}')">
                        <i class="fas fa-check"></i>
                        Accept
                    </button>
                    <button type="button" class="quote-btn quote-btn--reject" onclick="rejectQuote('${response.id}')">
                        <i class="fas fa-times"></i>
                        Reject
                    </button>
                </div>
            `;
        }
        return '';
    }
    
    getEmptyStateHTML() {
        const userType = '{{ user_type }}';
        return `
            <div class="quote-responses-empty" id="emptyState">
                <div class="quote-responses-empty__icon">
                    <i class="fas fa-reply"></i>
                </div>
                <h3 class="quote-responses-empty__title">No responses yet</h3>
                <p class="quote-responses-empty__text">
                    ${userType === 'buyer' 
                        ? "Sellers will respond to your quote request. You'll receive notifications when they do."
                        : "This quote request is still waiting for responses from sellers."
                    }
                </p>
            </div>
        `;
    }
    
    updateResponseCount(count) {
        const countElement = document.getElementById('responseCount');
        if (countElement) {
            countElement.textContent = `(${count})`;
        }
    }
    
    updateLastUpdateTime() {
        const updateElement = document.getElementById('lastUpdate');
        if (updateElement) {
            const now = new Date();
            const diff = Math.floor((now - this.lastUpdateTime) / 1000);
            
            let timeText;
            if (diff < 60) {
                timeText = 'Just updated';
            } else if (diff < 3600) {
                timeText = `Updated ${Math.floor(diff / 60)}m ago`;
            } else {
                timeText = `Updated ${Math.floor(diff / 3600)}h ago`;
            }
            
            updateElement.textContent = timeText;
        }
        
        // Update every minute
        setTimeout(() => this.updateLastUpdateTime(), 60000);
    }
    
    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
        });
    }
}

// Quote action functions
function acceptQuote(responseId) {
    console.log('Accepting quote response:', responseId);
    
    Swal.fire({
        title: 'Accept Quote?',
        text: 'Are you sure you want to accept this quote? This will reject all other responses.',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, Accept Quote',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'quote-swal-popup',
            confirmButton: 'quote-swal-confirm',
            cancelButton: 'quote-swal-cancel'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            console.log('User confirmed quote acceptance');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found');
            
            // Disable the button to prevent double-clicking
            const acceptButton = event.target.closest('button');
            if (acceptButton) {
                acceptButton.disabled = true;
                acceptButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';
            }
            
            fetch(`/quotes/response/${responseId}/accept/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Quote Accepted!',
                        text: data.message,
                        confirmButtonText: 'Proceed to Checkout',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        customClass: {
                            popup: 'quote-swal-popup',
                            confirmButton: 'quote-swal-confirm'
                        }
                    }).then(() => {
                        console.log('Redirect URL:', data.redirect_url);
                        if (data.redirect_url) {
                            console.log('Redirecting to:', data.redirect_url);
                            window.location.href = data.redirect_url;
                        } else {
                            console.log('No redirect URL, reloading page');
                            window.location.reload();
                        }
                    });
                } else {
                    console.error('Server returned error:', data.message);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'quote-swal-popup',
                            confirmButton: 'quote-swal-confirm'
                        }
                    });
                    
                    // Re-enable the button
                    if (acceptButton) {
                        acceptButton.disabled = false;
                        acceptButton.innerHTML = '<i class="fas fa-check"></i> Accept';
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while accepting the quote.',
                    confirmButtonText: 'OK',
                    customClass: {
                        popup: 'quote-swal-popup',
                        confirmButton: 'quote-swal-confirm'
                    }
                });
                
                // Re-enable the button
                if (acceptButton) {
                    acceptButton.disabled = false;
                    acceptButton.innerHTML = '<i class="fas fa-check"></i> Accept';
                }
            });
        }
    });
}

function rejectQuote(responseId) {
    Swal.fire({
        title: 'Reject Quote?',
        text: 'Are you sure you want to reject this quote?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, Reject Quote',
        cancelButtonText: 'Cancel',
        customClass: {
            popup: 'quote-swal-popup',
            confirmButton: 'quote-swal-confirm',
            cancelButton: 'quote-swal-cancel'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Disable the button to prevent double-clicking
            const rejectButton = event.target.closest('button');
            if (rejectButton) {
                rejectButton.disabled = true;
                rejectButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
            }
            
            fetch(`/quotes/response/${responseId}/reject/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Quote Rejected',
                        text: data.message,
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'quote-swal-popup',
                            confirmButton: 'quote-swal-confirm'
                        }
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonText: 'OK',
                        customClass: {
                            popup: 'quote-swal-popup',
                            confirmButton: 'quote-swal-confirm'
                        }
                    });
                    
                    // Re-enable the button
                    if (rejectButton) {
                        rejectButton.disabled = false;
                        rejectButton.innerHTML = '<i class="fas fa-times"></i> Reject';
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while rejecting the quote.',
                    confirmButtonText: 'OK',
                    customClass: {
                        popup: 'quote-swal-popup',
                        confirmButton: 'quote-swal-confirm'
                    }
                });
                
                // Re-enable the button
                if (rejectButton) {
                    rejectButton.disabled = false;
                    rejectButton.innerHTML = '<i class="fas fa-times"></i> Reject';
                }
            });
        }
    });
}

// Initialize the response manager when the page loads
let responseManager;

document.addEventListener('DOMContentLoaded', function() {
    responseManager = new QuoteResponseManager();
    
    // Stop polling when the page is about to unload
    window.addEventListener('beforeunload', function() {
        if (responseManager) {
            responseManager.stopPolling();
        }
    });
    
    // Pause polling when page is not visible (browser tab is inactive)
    document.addEventListener('visibilitychange', function() {
        if (responseManager) {
            if (document.hidden) {
                responseManager.stopPolling();
            } else {
                responseManager.startPolling();
            }
        }
    });
});

// Custom SweetAlert2 styles
const swalStyles = `
<style>
.quote-swal-popup {
    border-radius: 20px !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15) !important;
}

.quote-swal-confirm {
    border-radius: 12px !important;
    padding: 0.75rem 2rem !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.quote-swal-confirm:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important;
}

.quote-swal-cancel {
    border-radius: 12px !important;
    padding: 0.75rem 2rem !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.quote-swal-cancel:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

/* New response animation */
.new-response {
    animation: slideInFromTop 0.5s ease-out;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 2px solid #22c55e;
}

/* Updated response animation */
.updated-response {
    animation: pulseUpdate 0.5s ease-out;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
}

@keyframes slideInFromTop {
    0% {
        opacity: 0;
        transform: translateY(-20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulseUpdate {
    0% {
        opacity: 0.7;
        transform: scale(0.98);
    }
    50% {
        opacity: 1;
        transform: scale(1.02);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

/* Loading spinner for responses */
.quote-responses-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 0.75rem;
    border: 1px solid #e2e8f0;
    margin-bottom: 1rem;
}

.quote-responses-spinner {
    width: 1.5rem;
    height: 1.5rem;
    border: 2px solid #e2e8f0;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
`;

// Inject custom styles
document.head.insertAdjacentHTML('beforeend', swalStyles);
</script>
{% endblock %}
{% endblock %}