{% extends 'index.html' %}
{% load b64filters %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Dashboard</title>


{% block extra_css %}
<style>
/* Dashboard specific styles following design system */
.dashboard-header {
  background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
  color: white;
  padding: 2rem;
  border-radius: 0.75rem;
  margin: 0;
}

/* Enhanced Card Styling */
.card {
  background-color: var(--bg-primary);
  border-radius: 0.75rem;
  border: 1px solid var(--neutral-200);
  overflow: hidden;
  transition: all 0.3s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.card:hover {
  border-color: var(--neutral-300);
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.card-header {
  padding: 1.5rem;
  border-bottom: 1px solid var(--neutral-200);
  background-color: var(--bg-secondary);
  font-weight: 600;
}

.card-body {
  padding: 1.5rem;
}

.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 4px solid rgba(255, 255, 255, 0.2);
  object-fit: cover;
}

.stat-card {
  background: var(--bg-primary);
  border-radius: 0.75rem;
  padding: 1.5rem;
  border: 1px solid var(--neutral-200);
  text-align: center;
  transition: all 0.3s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
  border-color: var(--primary-blue);
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-blue);
  margin-bottom: 0.5rem;
}

.stat-label {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.tab-nav {
  border-bottom: 1px solid var(--neutral-200);
  margin-bottom: 2rem;
}

.tab-button {
  padding: 1rem 1.5rem;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
}

.tab-button.active {
  color: var(--primary-blue);
  border-bottom-color: var(--primary-blue);
}

.tab-button:hover {
  color: var(--text-primary);
  background-color: var(--neutral-100);
}

.tab-content {
  display: none;
  animation: slideUp 0.3s ease-out;
}

.tab-content.active {
  display: block;
}

.order-row, .product-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr auto;
  gap: 1rem;
  padding: 1rem;
  border-bottom: 1px solid var(--neutral-200);
  align-items: center;
}

.order-row:hover, .product-row:hover {
  background-color: var(--bg-secondary);
}

.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
}

.status-pending {
  background-color: #FFF3CD;
  color: #856404;
}

.status-completed {
  background-color: #D4EDDA;
  color: #155724;
}

.status-cancelled {
  background-color: #F8D7DA;
  color: #721C24;
}

.product-image {
  width: 50px;
  height: 50px;
  border-radius: 0.375rem;
  object-fit: cover;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: var(--bg-overlay);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--bg-primary);
  border-radius: 0.5rem;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.3s ease-out;
}

.notification-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--neutral-200);
  transition: background-color 0.2s ease;
}

.notification-item:hover {
  background-color: var(--bg-secondary);
}

.notification-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  font-size: 1.25rem;
}

.notification-new {
  background-color: var(--primary-blue-light);
  color: var(--primary-blue);
}

.notification-warning {
  background-color: #FFF3CD;
  color: var(--warning);
}

.chart-container {
  position: relative;
  height: 300px;
  margin: 2rem 0;
}

@media (max-width: 768px) {
  .order-row, .product-row {
    grid-template-columns: 1fr;
    gap: 0.5rem;
    text-align: left;
  }
  
  .dashboard-header {
    padding: 1rem 0;
  }
  
  .profile-avatar {
    width: 60px;
    height: 60px;
  }
  
  .tab-button {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
  }
}
</style>
{% endblock %}


<div class="container">
  <!-- Dashboard Header -->
  <div class="card mb-8">
    <div class="dashboard-header">
      <div class="flex items-center">
        {% if seller.image and seller.get_image_base64 %}
            <img src="data:image/jpeg;base64,{{ seller.get_image_base64 }}" alt="Shop Avatar" class="profile-avatar" id="profileAvatar">
        {% else %}
            <div class="profile-avatar bg-gray-300 flex items-center justify-center text-gray-600 font-bold text-xl" id="profileAvatar">
                {{ seller.shop_name|first|upper|default:"S" }}
            </div>
        {% endif %}
        <div class="ml-6">
          <h1 class="text-3xl font-bold mb-2" id="shopName">{{ seller.shop_name|default:"My Shop" }}</h1>
          <p class="text-lg opacity-90" id="shopBio">{{ seller.shop_description|default:"Welcome to my store!" }}</p>
          <a href="{% url 'seller:seller_profile' %}" class="btn btn-ghost mt-2 text-white border-white hover:bg-white hover:text-blue-600">
            View Profile
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="card mb-8">
    <div class="card-header">
      <h2 class="text-xl font-semibold">Dashboard Overview</h2>
    </div>
    <div class="card-body">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="stat-card">
          <div class="stat-value">${{ total_earnings|floatformat:0|default:"0" }}</div>
          <div class="stat-label">Total Earnings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ total_orders|default:"0" }}</div>
          <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ total_products|default:"0" }}</div>
          <div class="stat-label">Products</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${{ monthly_sales|floatformat:0|default:"0" }}</div>
          <div class="stat-label">This Month</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Content -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Main Content Area -->
    <div class="lg:col-span-3">
      <!-- Tab Navigation -->
      <div class="card mb-6">
        <div class="card-body p-0">
          <div class="tab-nav">
            <div class="flex flex-wrap">
              <button class="tab-button active" data-tab="orders">Orders</button>
              <button class="tab-button" data-tab="products">Products</button>
              <button class="tab-button" data-tab="reports">Reports</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders Tab -->
      <div class="tab-content active" id="orders">
        <div class="card">
          <div class="card-header flex justify-between items-center">
            <h3 class="text-lg font-semibold">Recent Orders</h3>
            <a href="{% url 'seller:orders_list' %}" class="btn btn-primary btn-sm">View All</a>
          </div>
          <div class="card-body p-0">
            <div class="order-row font-semibold bg-neutral-50 text-sm">
              <div>Order ID</div>
              <div>Customer</div>
              <div>Total</div>
              <div>Status</div>
              <div>Actions</div>
            </div>
            {% for order in recent_orders %}
            <div class="order-row">
              <div class="font-mono text-sm">#{{ order.id }}</div>
              <div>{{ order.customer.first_name }} {{ order.customer.last_name }}</div>
              <div class="font-semibold">${{ order.total|floatformat:2 }}</div>
              <div>
                <span class="status-badge status-{{ order.status|lower }}">{{ order.get_status_display }}</span>
              </div>
              <div>
                <button class="btn btn-ghost btn-sm" onclick="viewOrder('{{ order.id }}')">View</button>
              </div>
            </div>
            {% empty %}
            <div class="order-row">
              <div class="col-span-5 text-center text-neutral-500 py-8">No orders yet</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Products Tab -->
      <div class="tab-content" id="products">
        <div class="card">
          <div class="card-header flex justify-between items-center">
            <h3 class="text-lg font-semibold">Your Products</h3>
            <a href="{% url 'seller:products_list' %}" class="btn btn-primary">View All Products</a>
          </div>
          <div class="card-body p-0">
            <div class="product-row font-semibold bg-neutral-50 text-sm">
              <div>Product</div>
              <div>Price</div>
              <div>Stock</div>
              <div>Status</div>
              <div>Actions</div>
            </div>
            {% for product in products %}
            <div class="product-row">
              <div class="flex items-center">
                <img src="{{ product.image.url|default:'/static/images/default-product.jpg' }}" alt="{{ product.name }}" class="product-image mr-3">
                <div>
                  <div class="font-semibold">{{ product.name }}</div>
                  <div class="text-sm text-neutral-600">{{ product.category.name }}</div>
                </div>
              </div>
              <div class="font-semibold">${{ product.price|floatformat:2 }}</div>
              <div>{{ product.stock|default:"0" }}</div>
              <div>
                <span class="status-badge {% if product.is_active %}status-completed{% else %}status-cancelled{% endif %}">
                  {% if product.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </div>
              <div class="flex space-x-2">
                <button class="btn btn-ghost btn-sm" onclick="editProduct('{{ product.id }}')">Edit</button>
                <button class="btn btn-ghost btn-sm text-red-600" onclick="deleteProduct('{{ product.id }}')">Delete</button>
              </div>
            </div>
            {% empty %}
            <div class="product-row">
              <div class="col-span-5 text-center text-neutral-500 py-8">No products yet</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>



      <!-- Reports Tab -->
      <div class="tab-content" id="reports">
        <div class="card mb-6">
          <div class="card-header">
            <h3 class="text-lg font-semibold">Sales Analytics</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h4 class="text-md font-semibold mb-4">Sales Overview</h4>
                <div class="chart-container">
                  <canvas id="salesChart"></canvas>
                </div>
              </div>
              <div>
                <h4 class="text-md font-semibold mb-4">Revenue Breakdown</h4>
                <div class="space-y-4">
                  <div class="flex justify-between items-center p-3 bg-neutral-50 rounded">
                    <span>This Week</span>
                    <span class="font-semibold text-primary-blue">${{ weekly_revenue|floatformat:2|default:"0.00" }}</span>
                  </div>
                  <div class="flex justify-between items-center p-3 bg-neutral-50 rounded">
                    <span>This Month</span>
                    <span class="font-semibold text-primary-blue">${{ monthly_revenue|floatformat:2|default:"0.00" }}</span>
                  </div>
                  <div class="flex justify-between items-center p-3 bg-neutral-50 rounded">
                    <span>This Year</span>
                    <span class="font-semibold text-primary-blue">${{ yearly_revenue|floatformat:2|default:"0.00" }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="text-lg font-semibold">Top Selling Products</h3>
          </div>
          <div class="card-body">
            <div class="space-y-3">
              {% for product in top_products %}
              <div class="flex items-center justify-between p-3 bg-neutral-50 rounded">
                <div class="flex items-center">
                  {% if product.image %}
                    <img src="data:image/jpeg;base64,{{ product.get_image_base64 }}" alt="{{ product.name }}" class="w-10 h-10 rounded mr-3 object-cover">
                  {% else %}
                    <div class="w-10 h-10 rounded mr-3 bg-gray-200 flex items-center justify-center text-gray-500 text-xs">
                      {{ product.name|first|upper }}
                    </div>
                  {% endif %}
                  <div>
                    <div class="font-semibold">{{ product.name }}</div>
                    <div class="text-sm text-neutral-600">{{ product.order_count|default:"0" }} orders</div>
                  </div>
                </div>
                <div class="font-semibold text-primary-blue">${{ product.final_price|floatformat:2 }}</div>
              </div>
              {% empty %}
              <p class="text-center text-neutral-500 py-4">No sales data available</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="lg:col-span-1 space-y-6">
      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold">Quick Actions</h3>
        </div>
        <div class="card-body space-y-3">
          <button class="btn btn-primary w-full" onclick="openPromotionModal()">
            Create Promotion
          </button>
          <a href="{% url 'seller:add_product' %}" class="btn btn-secondary w-full">
            Add Product
          </a>
          <button class="btn btn-ghost w-full">
            Export Data
          </button>
        </div>
      </div>

      <!-- Notifications -->
      <div class="card">
        <div class="card-header">
          <h3 class="text-lg font-semibold">Notifications</h3>
        </div>
        <div class="card-body p-0">
          {% for notification in notifications %}
          <div class="notification-item">
            <div class="notification-icon {% if notification.type == 'order' %}notification-new{% elif notification.type == 'stock' %}notification-warning{% endif %}">
              {% if notification.type == 'order' %}📦{% elif notification.type == 'stock' %}⚠️{% endif %}
            </div>
            <div class="flex-1">
              <div class="font-semibold text-sm">{{ notification.title }}</div>
              <div class="text-xs text-neutral-600">{{ notification.message }}</div>
              <div class="text-xs text-neutral-500 mt-1">{{ notification.created_at|timesince }} ago</div>
            </div>
          </div>
          {% empty %}
          <div class="notification-item">
            <div class="text-center text-neutral-500 w-full py-4">No new notifications</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Create Promotion Modal -->
<div class="modal" id="promotionModal">
  <div class="modal-content">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Create Promotion</h3>
      <button class="btn btn-ghost" onclick="closeModal('promotionModal')">&times;</button>
    </div>
    <form id="promotionForm">
      {% csrf_token %}
      <div class="form-group">
        <label class="form-label">Promotion Name</label>
        <input type="text" class="form-input" placeholder="Summer Sale 2024" required>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Discount (%)</label>
          <input type="number" class="form-input" min="1" max="99" placeholder="20" required>
        </div>
        <div class="form-group">
          <label class="form-label">Valid Until</label>
          <input type="date" class="form-input" required>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Products</label>
        <select class="form-input" multiple>
          {% for product in products %}
          <option value="{{ product.id }}">{{ product.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" class="btn btn-secondary" onclick="closeModal('promotionModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Promotion</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Tab switching functionality
function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Show selected tab content
  document.getElementById(tabName).classList.add('active');
  
  // Add active class to clicked tab button
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
}

// Add event listeners for tab buttons
document.querySelectorAll('.tab-button').forEach(button => {
  button.addEventListener('click', () => {
    const tabName = button.getAttribute('data-tab');
    switchTab(tabName);
  });
});

// Modal functionality
function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
  document.body.style.overflow = 'auto';
}



function openPromotionModal() {
  openModal('promotionModal');
}

// Close modal when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal(modal.id);
    }
  });
});

// Form validation and submission
class FormValidator {
  constructor(form) {
    this.form = form;
    this.init();
  }
  
  init() {
    this.form.addEventListener('submit', this.handleSubmit.bind(this));
    this.setupRealTimeValidation();
  }
  
  setupRealTimeValidation() {
    const inputs = this.form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
      input.addEventListener('blur', () => this.validateField(input));
    });
  }
  
  validateField(field) {
    const value = field.value.trim();
    let isValid = true;
    let message = '';
    
    if (field.hasAttribute('required') && !value) {
      isValid = false;
      message = 'This field is required';
    } else if (field.type === 'email' && value && !this.isValidEmail(value)) {
      isValid = false;
      message = 'Please enter a valid email address';
    } else if (field.type === 'number' && value && isNaN(value)) {
      isValid = false;
      message = 'Please enter a valid number';
    }
    
    this.updateFieldState(field, isValid, message);
    return isValid;
  }
  
  updateFieldState(field, isValid, message) {
    const errorElement = field.parentElement.querySelector('.form-error');
    
    if (isValid) {
      field.classList.remove('invalid');
      if (errorElement) errorElement.textContent = '';
    } else {
      field.classList.add('invalid');
      if (errorElement) errorElement.textContent = message;
    }
  }
  
  isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }
  
  handleSubmit(e) {
    e.preventDefault();
    
    const inputs = this.form.querySelectorAll('input, textarea, select');
    let isFormValid = true;
    
    inputs.forEach(input => {
      if (!this.validateField(input)) {
        isFormValid = false;
      }
    });
    
    if (isFormValid) {
      const submitBtn = this.form.querySelector('[type="submit"]');
      const originalText = submitBtn.innerHTML;
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Saving...';
      
      // Simulate form submission (replace with actual AJAX call)
      setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        // Show success message or handle response
                if (this.form.id === 'addProductForm') {
          alert('Product added successfully!');
          this.form.reset();
        }
      }, 2000);
    }
  }
  

}

// Initialize form validators
document.addEventListener('DOMContentLoaded', () => {
  // Initialize form validation
  document.querySelectorAll('form').forEach(form => {
    new FormValidator(form);
  });
  
  // Initialize sales chart
  initSalesChart();
});

// Product management functions
function editProduct(productId) {
  // In a real application, this would fetch product data and populate a modal
  console.log('Edit product:', productId);
  alert('Edit product functionality would be implemented here');
}

function deleteProduct(productId) {
  if (confirm('Are you sure you want to delete this product?')) {
    console.log('Delete product:', productId);
    alert('Delete product functionality would be implemented here');
  }
}

function viewOrder(orderId) {
  console.log('View order:', orderId);
  alert('View order functionality would be implemented here');
}

// Chart initialization
function initSalesChart() {
  const ctx = document.getElementById('salesChart');
  if (!ctx) return;
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [{
        label: 'Sales',
        data: [1200, 1900, 3000, 5000, 2000, 3000],
        borderColor: 'rgb(66, 133, 244)',
        backgroundColor: 'rgba(66, 133, 244, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });
}

// Theme handling (if dark mode toggle exists)
const initThemeSwitch = () => {
  const theme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', theme);
  
  const toggleTheme = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  };
  
  const themeToggle = document.getElementById('theme-toggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }
};

// Loading state management
class LoadingManager {
  static show(element, text = 'Loading...') {
    element.disabled = true;
    element.innerHTML = `
      <span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
      ${text}
    `;
  }
  
  static hide(element, originalText) {
    element.disabled = false;
    element.innerHTML = originalText;
  }
}

// Real-time updates simulation (would connect to WebSocket in production)
function simulateRealTimeUpdates() {
  // Simulate new order notifications
  setInterval(() => {
    if (Math.random() > 0.95) { // 5% chance every interval
      showNotification('New order received!', 'order');
    }
  }, 10000); // Check every 10 seconds
  
  // Simulate stock alerts
  setInterval(() => {
    if (Math.random() > 0.98) { // 2% chance every interval
      showNotification('Low stock alert for Product XYZ', 'stock');
    }
  }, 15000); // Check every 15 seconds
}

function showNotification(message, type) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification-item animate-slideUp`;
  notification.innerHTML = `
    <div class="notification-icon ${type === 'order' ? 'notification-new' : 'notification-warning'}">
      ${type === 'order' ? '📦' : '⚠️'}
    </div>
    <div class="flex-1">
      <div class="font-semibold text-sm">${type === 'order' ? 'New Order' : 'Stock Alert'}</div>
      <div class="text-xs text-neutral-600">${message}</div>
      <div class="text-xs text-neutral-500 mt-1">Just now</div>
    </div>
  `;
  
  // Add to notifications section
  const notificationsContainer = document.querySelector('.card:last-child .card-body');
  if (notificationsContainer) {
    const emptyMessage = notificationsContainer.querySelector('.text-center');
    if (emptyMessage) {
      emptyMessage.remove();
    }
    notificationsContainer.insertBefore(notification, notificationsContainer.firstChild);
    
    // Remove after 30 seconds
    setTimeout(() => {
      notification.remove();
    }, 30000);
  }
}

// Search and filter functionality
function initSearchAndFilter() {
  // Add search functionality for products and orders
  const searchInputs = document.querySelectorAll('[data-search]');
  
  searchInputs.forEach(input => {
    input.addEventListener('input', debounce((e) => {
      const searchTerm = e.target.value.toLowerCase();
      const targetTable = e.target.getAttribute('data-search');
      const rows = document.querySelectorAll(`#${targetTable} .${targetTable.slice(0, -1)}-row:not(.font-semibold)`);
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }, 300));
  });
}

// Debounce function for performance
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

// Image preview functionality
function initImagePreview() {
  const imageInputs = document.querySelectorAll('input[type="file"][accept*="image"]');
  
  imageInputs.forEach(input => {
    input.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          // Create or update image preview
          let preview = input.parentElement.querySelector('.image-preview');
          if (!preview) {
            preview = document.createElement('img');
            preview.className = 'image-preview mt-2 w-20 h-20 object-cover rounded border';
            input.parentElement.appendChild(preview);
          }
          preview.src = e.target.result;
          
          // For profile picture, also update the header avatar
          if (input.id === 'editProfilePicture') {
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar.tagName === 'IMG') {
              profileAvatar.src = e.target.result;
            } else {
              // Replace fallback div with image
              const newImg = document.createElement('img');
              newImg.src = e.target.result;
              newImg.alt = 'Shop Avatar';
              newImg.className = 'profile-avatar';
              newImg.id = 'profileAvatar';
              profileAvatar.parentNode.replaceChild(newImg, profileAvatar);
            }
          }
        };
        reader.readAsDataURL(file);
      }
    });
  });
}

// Export functionality
function exportData(type) {
  const data = [];
  
  if (type === 'orders') {
    // Collect order data
    const orderRows = document.querySelectorAll('#orders .order-row:not(.font-semibold)');
    orderRows.forEach(row => {
      const cells = row.querySelectorAll('div');
      if (cells.length >= 4) {
        data.push({
          orderId: cells[0].textContent.trim(),
          customer: cells[1].textContent.trim(),
          total: cells[2].textContent.trim(),
          status: cells[3].textContent.trim()
        });
      }
    });
  } else if (type === 'products') {
    // Collect product data
    const productRows = document.querySelectorAll('#products .product-row:not(.font-semibold)');
    productRows.forEach(row => {
      const cells = row.querySelectorAll('div');
      if (cells.length >= 4) {
        data.push({
          product: cells[0].textContent.trim(),
          price: cells[1].textContent.trim(),
          stock: cells[2].textContent.trim(),
          status: cells[3].textContent.trim()
        });
      }
    });
  }
  
  // Convert to CSV and download
  if (data.length > 0) {
    const csv = convertToCSV(data);
    downloadCSV(csv, `${type}_export_${new Date().toISOString().split('T')[0]}.csv`);
  }
}

function convertToCSV(data) {
  if (data.length === 0) return '';
  
  const headers = Object.keys(data[0]);
  const csvContent = [
    headers.join(','),
    ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
  ].join('\n');
  
  return csvContent;
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Keyboard shortcuts
function initKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Alt + 1-4 for tab switching
    if (e.altKey && !e.shiftKey && !e.ctrlKey) {
      const tabMap = {
        '1': 'orders',
        '2': 'products', 
        '3': 'reports'
      };
      
      if (tabMap[e.key]) {
        e.preventDefault();
        switchTab(tabMap[e.key]);
      }
    }
    
    // Escape to close modals
    if (e.key === 'Escape') {
      const activeModal = document.querySelector('.modal.active');
      if (activeModal) {
        closeModal(activeModal.id);
      }
    }
    
    // Ctrl/Cmd + K for quick search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      const searchInput = document.querySelector('[data-search]');
      if (searchInput) {
        searchInput.focus();
      }
    }
  });
}

// Auto-save for forms
function initAutoSave() {
  const forms = document.querySelectorAll('form[data-autosave]');
  
  forms.forEach(form => {
    const inputs = form.querySelectorAll('input, textarea, select');
    const formId = form.id || form.className;
    
    // Load saved data
    inputs.forEach(input => {
      const savedValue = localStorage.getItem(`autosave_${formId}_${input.name}`);
      if (savedValue && input.type !== 'file') {
        input.value = savedValue;
      }
    });
    
    // Save on input
    inputs.forEach(input => {
      input.addEventListener('input', debounce(() => {
        if (input.type !== 'file') {
          localStorage.setItem(`autosave_${formId}_${input.name}`, input.value);
        }
      }, 1000));
    });
    
    // Clear on successful submit
    form.addEventListener('submit', () => {
      inputs.forEach(input => {
        localStorage.removeItem(`autosave_${formId}_${input.name}`);
      });
    });
  });
}

// Initialize all functionality
document.addEventListener('DOMContentLoaded', () => {
  // Core functionality
  initThemeSwitch();
  initSearchAndFilter();
  initImagePreview();
  initKeyboardShortcuts();
  initAutoSave();
  
  // Start real-time updates simulation
  simulateRealTimeUpdates();
  
  // Add export functionality to export button
  const exportBtn = document.querySelector('.btn.btn-ghost.w-full');
  if (exportBtn && exportBtn.textContent.includes('Export')) {
    exportBtn.addEventListener('click', () => {
      const activeTab = document.querySelector('.tab-content.active').id;
      if (activeTab === 'orders' || activeTab === 'products') {
        exportData(activeTab);
      }
    });
  }
  
  // Initialize tooltips for better UX
  initTooltips();
});

// Tooltip functionality
function initTooltips() {
  const tooltipElements = document.querySelectorAll('[data-tooltip]');
  
  tooltipElements.forEach(element => {
    element.addEventListener('mouseenter', showTooltip);
    element.addEventListener('mouseleave', hideTooltip);
  });
}

function showTooltip(e) {
  const tooltipText = e.target.getAttribute('data-tooltip');
  const tooltip = document.createElement('div');
  
  tooltip.className = 'tooltip';
  tooltip.textContent = tooltipText;
  tooltip.style.cssText = `
    position: absolute;
    background: var(--neutral-800);
    color: white;
    padding: 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    z-index: 1000;
    white-space: nowrap;
    pointer-events: none;
  `;
  
  document.body.appendChild(tooltip);
  
  const rect = e.target.getBoundingClientRect();
  const tooltipRect = tooltip.getBoundingClientRect();
  
  tooltip.style.left = `${rect.left + (rect.width - tooltipRect.width) / 2}px`;
  tooltip.style.top = `${rect.top - tooltipRect.height - 5}px`;
  
  e.target._tooltip = tooltip;
}

function hideTooltip(e) {
  if (e.target._tooltip) {
    document.body.removeChild(e.target._tooltip);
    delete e.target._tooltip;
  }
}
</script>
{% endblock %}
  