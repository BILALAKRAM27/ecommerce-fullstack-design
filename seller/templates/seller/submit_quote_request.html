{% extends 'index.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="quote-request-container">
    <div class="quote-request-wrapper">
        <div class="quote-request-card">
            <div class="quote-request-header">
                <div class="quote-request-header-content">
                    <div class="quote-request-icon-wrapper">
                        <svg class="quote-request-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                    </div>
                    <div class="quote-request-header-text">
                        <h1 class="quote-request-title">Submit Quote Request</h1>
                        <p class="quote-request-subtitle">Tell suppliers what you need and get competitive quotes</p>
                    </div>
                </div>
            </div>
            
            <div class="quote-request-body">
                <form id="quoteRequestForm" method="POST" action="{% url 'sellers:submit_quote_request' %}" class="quote-request-form">
                    {% csrf_token %}
                    
                    <div class="quote-request-form-grid">
                        <div class="quote-request-form-group">
                            <label for="{{ form.product_name.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                </svg>
                                Product Name *
                            </label>
                            {{ form.product_name|add_class:"quote-request-input" }}
                            {% if form.product_name.errors %}
                                <div class="quote-request-error">{{ form.product_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="quote-request-form-group">
                            <label for="{{ form.category.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                </svg>
                                Category *
                            </label>
                            {{ form.category|add_class:"quote-request-select" }}
                            {% if form.category.errors %}
                                <div class="quote-request-error">{{ form.category.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="quote-request-form-group">
                        <label for="{{ form.description.id_for_label }}" class="quote-request-label">
                            <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10,9 9,9 8,9"></polyline>
                            </svg>
                            Description *
                        </label>
                        {{ form.description|add_class:"quote-request-textarea" }}
                        {% if form.description.errors %}
                            <div class="quote-request-error">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="quote-request-form-grid-3">
                        <div class="quote-request-form-group">
                            <label for="{{ form.quantity.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                Quantity *
                            </label>
                            {{ form.quantity|add_class:"quote-request-input" }}
                            {% if form.quantity.errors %}
                                <div class="quote-request-error">{{ form.quantity.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="quote-request-form-group">
                            <label for="{{ form.unit.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.54 15H17a2 2 0 0 0-2 2v4.54"></path>
                                    <path d="M7 3.34V5a3 3 0 0 0 3 3v0a2 2 0 0 1 2 2v0c0 1.1.9 2 2 2v0a2 2 0 0 0 2-2v0c0-1.1.9-2 2-2h3.17"></path>
                                    <path d="M11 21.95V18a2 2 0 0 0-2-2v0a2 2 0 0 1-2-2v-1a2 2 0 0 0-2-2H2.05"></path>
                                </svg>
                                Unit *
                            </label>
                            {{ form.unit|add_class:"quote-request-select" }}
                            {% if form.unit.errors %}
                                <div class="quote-request-error">{{ form.unit.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="quote-request-form-group">
                            <label for="{{ form.urgency.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12,6 12,12 16,14"></polyline>
                                </svg>
                                Urgency *
                            </label>
                            {{ form.urgency|add_class:"quote-request-select" }}
                            {% if form.urgency.errors %}
                                <div class="quote-request-error">{{ form.urgency.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="quote-request-form-grid">
                        <div class="quote-request-form-group">
                            <label for="{{ form.budget_range.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                Budget Range
                            </label>
                            {{ form.budget_range|add_class:"quote-request-input" }}
                            {% if form.budget_range.errors %}
                                <div class="quote-request-error">{{ form.budget_range.errors.0 }}</div>
                            {% endif %}
                            <small class="quote-request-hint">e.g., $100-500</small>
                        </div>
                        
                        <div class="quote-request-form-group">
                            <label for="{{ form.delivery_deadline.id_for_label }}" class="quote-request-label">
                                <svg class="quote-request-label-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                Delivery Deadline
                            </label>
                            {{ form.delivery_deadline|add_class:"quote-request-input" }}
                            {% if form.delivery_deadline.errors %}
                                <div class="quote-request-error">{{ form.delivery_deadline.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="quote-request-info-card">
                        <div class="quote-request-info-header">
                            <svg class="quote-request-info-icon" viewBox="0 0 50 50" fill="currentColor">
                                <path d="M 25 2 C 12.309295 2 2 12.309295 2 25 C 2 37.690705 12.309295 48 25 48 C 37.690705 48 48 37.690705 48 25 C 48 12.309295 37.690705 2 25 2 z M 25 4 C 36.609824 4 46 13.390176 46 25 C 46 36.609824 36.609824 46 25 46 C 13.390176 46 4 36.609824 4 25 C 4 13.390176 13.390176 4 25 4 z M 25 11 A 3 3 0 0 0 22 14 A 3 3 0 0 0 25 17 A 3 3 0 0 0 28 14 A 3 3 0 0 0 25 11 z M 21 21 L 21 23 L 22 23 L 23 23 L 23 36 L 22 36 L 21 36 L 21 38 L 22 38 L 23 38 L 27 38 L 28 38 L 29 38 L 29 36 L 28 36 L 27 36 L 27 21 L 26 21 L 22 21 L 21 21 z"></path>
                            </svg>
                            <span class="quote-request-info-title">How it works</span>
                        </div>
                        <ul class="quote-request-info-list">
                            <li>Your quote request will be sent to all relevant suppliers</li>
                            <li>Suppliers will respond with their best offers</li>
                            <li>You'll receive notifications when suppliers respond</li>
                            <li>You can accept the best offer and proceed to checkout</li>
                        </ul>
                    </div>
                    
                    <div class="quote-request-form-actions">
                        <button type="button" class="quote-request-btn-secondary" onclick="history.back()">
                            <svg class="quote-request-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5"></path>
                                <path d="M12 19l-7-7 7-7"></path>
                            </svg>
                            Cancel
                        </button>
                        <button type="submit" class="quote-request-btn-primary" id="submitBtn">
                            <svg class="quote-request-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                            </svg>
                            Submit Quote Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% block extra_js %}
<script>
// Prevent double submission
let isSubmitting = false;

document.getElementById('quoteRequestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Prevent double submission
    if (isSubmitting) {
        return false;
    }
    
    isSubmitting = true;
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<svg class="quote-request-spinner" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416"><animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/><animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/></circle></svg>Submitting...';
    submitBtn.disabled = true;
    
    const formData = new FormData(this);
    
    fetch('{% url "sellers:submit_quote_request" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and automatically redirect after 2 seconds
            Swal.fire({
                icon: 'success',
                title: 'Quote Request Submitted!',
                text: data.message,
                timer: 2000,
                timerProgressBar: true,
                showConfirmButton: false,
                allowOutsideClick: false
            }).then(() => {
                // Redirect to quotes page after modal closes
                window.location.href = '{% url "sellers:buyer_quote_requests" %}';
            });
        } else {
            // Show error message
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message,
                confirmButtonText: 'OK'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while submitting your quote request. Please try again.',
            confirmButtonText: 'OK'
        });
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        isSubmitting = false;
    });
});
</script>
{% endblock %}
{% endblock content %}

{% block extra_css %}
<style>
/* Quote Request Form Styles - Scoped to prevent conflicts */
.quote-request-container {
    min-height: 100vh;
    background: #ffffff;
    padding: 2rem 1rem;
    font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.quote-request-wrapper {
    max-width: 900px;
    margin: 0 auto;
}

.quote-request-card {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    animation: quote-request-slideUp 0.6s ease-out;
}

@keyframes quote-request-slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.quote-request-header {
    background: linear-gradient(135deg, #4285F4 0%, #667eea 100%);
    padding: 2rem;
    color: white;
}

.quote-request-header-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.quote-request-icon-wrapper {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1rem;
    backdrop-filter: blur(10px);
}

.quote-request-icon {
    width: 32px;
    height: 32px;
}

.quote-request-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
}

.quote-request-subtitle {
    font-size: 1rem;
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    line-height: 1.4;
}

.quote-request-body {
    padding: 2.5rem;
}

.quote-request-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.quote-request-form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

.quote-request-form-grid-3 {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
}

@media (min-width: 768px) {
    .quote-request-form-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .quote-request-form-grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
    }
}

.quote-request-form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.quote-request-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #f6f6f6;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.quote-request-label-icon {
    width: 16px;
    height: 16px;
    color: #4285F4;
}

.quote-request-input,
.quote-request-select,
.quote-request-textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #E0E0E0;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: #ffffff;
    font-family: inherit;
    box-sizing: border-box;
}

.quote-request-textarea {
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
}

.quote-request-input:focus,
.quote-request-select:focus,
.quote-request-textarea:focus {
    outline: none;
    border-color: #4285F4;
    box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    transform: translateY(-1px);
}

.quote-request-input:hover,
.quote-request-select:hover,
.quote-request-textarea:hover {
    border-color: #BDBDBD;
}

.quote-request-error {
    color: #E74C3C;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.quote-request-hint {
    color: #757575;
    font-size: 0.8125rem;
    margin-top: 0.25rem;
}

.quote-request-info-card {
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid rgba(66, 133, 244, 0.1);
}

.quote-request-info-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.quote-request-info-icon {
    width: 20px;
    height: 20px;
    color: #f0f7ff;
}

.quote-request-info-title {
    font-weight: 600;
    color: #f0f7ff;
    font-size: 1rem;
}

.quote-request-info-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.quote-request-info-list li {
    position: relative;
    padding-left: 1.5rem;
    color: #f0f7ff;
    font-size: 0.875rem;
    line-height: 1.5;
}

.quote-request-info-list li::before {
    content: '✓';
    position: absolute;
    left: 0;
    color: #2ECC71;
    font-weight: bold;
}

.quote-request-form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1rem;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .quote-request-form-actions {
        flex-direction: column-reverse;
    }
}

.quote-request-btn-primary,
.quote-request-btn-secondary {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    white-space: nowrap;
    min-height: 44px;
}

.quote-request-btn-primary {
    background: linear-gradient(135deg, #4285F4 0%, #667eea 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
}

.quote-request-btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
}

.quote-request-btn-primary:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

.quote-request-btn-secondary {
    background: transparent;
    color: #757575;
    border: 2px solid #E0E0E0;
}

.quote-request-btn-secondary:hover {
    background-color: #F5F5F5;
    border-color: #BDBDBD;
    color: #424242;
    transform: translateY(-1px);
}

.quote-request-btn-icon {
    width: 16px;
    height: 16px;
}

.quote-request-spinner {
    width: 16px;
    height: 16px;
    animation: quote-request-spin 1s linear infinite;
}

@keyframes quote-request-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .quote-request-container {
        padding: 1rem;
    }
    
    .quote-request-header {
        padding: 1.5rem;
    }
    
    .quote-request-header-content {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .quote-request-title {
        font-size: 1.5rem;
    }
    
    .quote-request-body {
        padding: 1.5rem;
    }
    
    .quote-request-form-grid-3 {
        grid-template-columns: 1fr;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .quote-request-card {
        background: #fffefe;
    }
    
    .quote-request-label {
        color: #1a1a1a;
    }
    
    .quote-request-input,
    .quote-request-select,
    .quote-request-textarea {
        background-color: #ffffff;
        border-color: #404040;
        color: #232323;
    }
    
    .quote-request-info-card {
        background: linear-gradient(135deg, #565982 0%, #9da9fe 100%);
        border-color: rgba(66, 133, 244, 0.2);
    }
}

/* Accessibility improvements */
.quote-request-input:focus,
.quote-request-select:focus,
.quote-request-textarea:focus {
    outline: 2px solid #4285F4;
    outline-offset: 2px;
}

@media (prefers-reduced-motion: reduce) {
    .quote-request-card,
    .quote-request-input,
    .quote-request-select,
    .quote-request-textarea,
    .quote-request-btn-primary,
    .quote-request-btn-secondary {
        animation: none;
        transition: none;
    }
}
</style>
{% endblock %}